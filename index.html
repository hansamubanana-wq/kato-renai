<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ‹ã®åå·®å€¤ã‚¨ãƒ©ãƒ¼ ã€œåŠ è—¤å…ˆç”Ÿã€è¨ˆç®—ãŒåˆã„ã¾ã›ã‚“ï¼ã€œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
        }

        #title-screen {
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            position: relative;
        }

        #title-screen h1 {
            font-size: 24px;
            color: #1565c0;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        #title-screen h2 {
            font-size: 18px;
            color: #1976d2;
            margin-bottom: 30px;
        }

        #title-screen .concept {
            font-size: 16px;
            color: #424242;
            font-weight: bold;
            margin-bottom: 20px;
            font-style: italic;
        }

        #title-screen .description {
            font-size: 14px;
            color: #616161;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
        #mode-select {
            display: none;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(180deg, #fff9c4 0%, #fff59d 100%);
        }

        #mode-select h2 {
            font-size: 22px;
            color: #f57f17;
            margin-bottom: 30px;
        }

        .mode-button {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin: 15px auto;
            background: white;
            border: 3px solid #fbc02d;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
        }

        .mode-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(251, 192, 45, 0.3);
        }

        .mode-button h3 {
            font-size: 20px;
            color: #f57f17;
            margin-bottom: 10px;
        }

        .mode-button p {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        /* åå‰å…¥åŠ› */
        #name-input-screen {
            display: none;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(180deg, #fce4ec 0%, #f8bbd0 100%);
        }

        #name-input-screen h2 {
            font-size: 22px;
            color: #c2185b;
            margin-bottom: 20px;
        }

        #name-input-screen .valentine-note {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ec407a;
        }

        #name-input-screen .valentine-note p {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        #name-input-screen input {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ec407a;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .start-button {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
        }

        .start-button:active {
            transform: scale(0.95);
        }

        .start-button.pink {
            background: linear-gradient(135deg, #ec407a, #d81b60);
        }

        #game-screen {
            display: none;
        }

        .game-header {
            background: #1976d2;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        .game-header.romance {
            background: linear-gradient(135deg, #ec407a, #f48fb1);
        }

        .game-header.valentine {
            background: linear-gradient(135deg, #ec407a, #f48fb1);
            animation: valentine-glow 2s infinite;
        }

        @keyframes valentine-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(236, 64, 122, 0.5); }
            50% { box-shadow: 0 0 20px rgba(236, 64, 122, 0.8); }
        }

        .game-header.horror {
            background: linear-gradient(135deg, #ec407a, #ab47bc);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        #status-bar {
            background: white;
            padding: 15px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat {
            flex: 1;
            min-width: 100px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
        }

        .stat-value.danger {
            color: #d32f2f;
        }

        .stat-value.love {
            color: #ec407a;
        }

        .stat-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            transition: width 0.5s;
        }

        .stat-bar-fill.love {
            background: linear-gradient(90deg, #ec407a, #f48fb1);
        }

        .stat-bar-fill.san {
            background: linear-gradient(90deg, #d32f2f, #f44336);
        }

        #items {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .item {
            padding: 5px 10px;
            background: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 5px;
            font-size: 12px;
        }

        .item.chocolate {
            background: #fce4ec;
            border: 1px solid #ec407a;
        }

        #text-window {
            min-height: 250px;
            padding: 30px 20px;
            background: #f5f5f5;
            position: relative;
            overflow: hidden;
        }

        #text-window.normal {
            background: repeating-linear-gradient(
                0deg,
                #e3f2fd,
                #e3f2fd 30px,
                #90caf9 30px,
                #90caf9 31px
            );
        }

        #text-window.romance {
            background: repeating-linear-gradient(
                0deg,
                #fce4ec,
                #fce4ec 30px,
                #f8bbd0 30px,
                #f8bbd0 31px
            );
        }

        #text-window.valentine {
            background: repeating-linear-gradient(
                45deg,
                #fce4ec,
                #fce4ec 30px,
                #f8bbd0 30px,
                #f8bbd0 31px
            );
        }

        #text-window.horror {
            background: repeating-linear-gradient(
                45deg,
                #fce4ec,
                #fce4ec 30px,
                #f8bbd0 30px,
                #f8bbd0 31px
            );
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* ã‚­ãƒ£ãƒ©ç«‹ã¡çµµé¢¨ */
        .character-portrait {
            text-align: center;
            font-size: 80px;
            margin: 10px 0;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #text-content {
            font-size: 16px;
            line-height: 1.8;
            color: #212121;
            position: relative;
            z-index: 2;
        }

        .character-name {
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 10px;
            display: block;
        }

        .character-name.nami {
            color: #ec407a;
        }

        .character-name.player {
            color: #1976d2;
        }

        .character-name.horror {
            color: #c2185b;
        }

        .inner-thought {
            font-style: italic;
            color: #999;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
        }

        #math-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .math-symbol {
            position: absolute;
            font-size: 24px;
            color: rgba(25, 118, 210, 0.2);
            animation: float 3s infinite;
        }

        /* ãƒãƒ¼ãƒˆï¼†ãƒãƒ§ã‚³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .heart-symbol {
            position: absolute;
            font-size: 24px;
            color: rgba(236, 64, 122, 0.3);
            animation: floatHeart 3s infinite;
        }

        .chocolate-symbol {
            position: absolute;
            font-size: 24px;
            animation: floatChoco 3s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        @keyframes floatHeart {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.2); }
        }

        @keyframes floatChoco {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-25px) rotate(360deg); }
        }

        #choices {
            padding: 20px;
            background: white;
        }

        .choice-button {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #1976d2;
            border-radius: 10px;
            font-size: 15px;
            color: #1565c0;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            line-height: 1.5;
        }

        .choice-button:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .choice-button:active {
            transform: scale(0.98);
        }

        .choice-button.romance {
            border-color: #ec407a;
            color: #c2185b;
        }

        .choice-button.romance:hover {
            background: #fce4ec;
        }

        .choice-button.horror {
            border-color: #ab47bc;
            color: #8e24aa;
        }

        .choice-button.horror:hover {
            background: #f3e5f5;
        }

        .continue-button {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .continue-button.romance {
            background: linear-gradient(135deg, #ec407a, #f48fb1);
        }

        /* é€ƒèµ°åŠ‡ãƒãƒƒãƒ— */
        #escape-map {
            display: none;
            padding: 20px;
            background: white;
        }

        #map-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .map-cell {
            aspect-ratio: 1;
            border: 2px solid #ec407a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .map-cell.player {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .map-cell.matsumoto {
            background: #fce4ec;
            animation: glow 1s infinite;
        }

        .map-cell.safe {
            background: #f1f8e9;
            border-color: #689f38;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px #ec407a; }
            50% { box-shadow: 0 0 20px #ec407a; }
        }

        .map-info {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .map-danger {
            color: #d32f2f;
            font-weight: bold;
        }

        /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        #input-section {
            display: none;
            padding: 20px;
            background: white;
        }

        #input-section input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ec407a;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        #timer {
            text-align: center;
            font-size: 24px;
            color: #c2185b;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .submit-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ec407a, #ab47bc);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        /* æ•°å¼ãƒŸãƒ‹ã‚²ãƒ¼ãƒ  */
        #math-game {
            display: none;
            padding: 20px;
            background: white;
            text-align: center;
        }

        #math-question {
            font-size: 24px;
            font-weight: bold;
            color: #1565c0;
            margin: 20px 0;
        }

        #math-input {
            width: 200px;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #1976d2;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        /* ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° */
        #ending-screen {
            display: none;
            padding: 40px 20px;
            text-align: center;
            min-height: 400px;
        }

        #ending-screen.normal {
            background: linear-gradient(180deg, #e3f2fd 0%, #90caf9 100%);
        }

        #ending-screen.bad {
            background: linear-gradient(180deg, #fce4ec 0%, #f8bbd0 100%);
        }

        #ending-screen.true {
            background: linear-gradient(180deg, #fff9c4 0%, #fff59d 100%);
        }

        #ending-screen.nami {
            background: linear-gradient(180deg, #fce4ec 0%, #f8bbd0 50%, #fff9c4 100%);
        }

        #ending-screen h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #ending-screen p {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .restart-button {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
        }

        /* é€šçŸ¥ */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        #notification.love {
            background: rgba(236, 64, 122, 0.9);
        }

        @media (max-width: 400px) {
            #title-screen h1 {
                font-size: 20px;
            }
            
            #text-content {
                font-size: 14px;
            }
            
            .choice-button {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="notification"></div>
    
    <div id="game-container">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen">
            <h1>æ‹ã®åå·®å€¤ã‚¨ãƒ©ãƒ¼</h1>
            <h2>ã€œåŠ è—¤å…ˆç”Ÿã€è¨ˆç®—ãŒåˆã„ã¾ã›ã‚“ï¼ã€œ</h2>
            <div class="concept">ã€Œæ„›ã¯è«–ç†ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã§ã¯è§£ã‘ãªã„ã€‚ã€</div>
            <div class="description">
                è«–ç†çš„æ€è€ƒã¨é’ãƒšãƒ³ã‚’æ­¦å™¨ã«ç”Ÿãã‚‹å …ç‰©æ•°å­¦æ•™å¸«ãƒ»åŠ è—¤ãŒã€<br>
                ã€Œæ‹æ„›ã€ã¨ã„ã†æœ€å¤§ã®éè«–ç†çš„èª²é¡Œã«æŒ‘ã‚€ã€‚<br>
                è‹¥æ‰‹äººæ°—æ•™å¸«ã¸ã®å‹˜é•ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€<br>
                è‚‰é£Ÿç³»ãŠã°ã•ã‚“æ•™å¸«ã‹ã‚‰ã®ãƒ›ãƒ©ãƒ¼ãªé€ƒèµ°åŠ‡ã€<br>
                ãã—ã¦éš£å¸­ã®ç†Ÿå¹´æ•™å¸«ã¨ã®çœŸå®Ÿã®æ„›ã€‚
            </div>
            <button class="start-button" onclick="showModeSelect()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ -->
        <div id="mode-select">
            <h2>ğŸ® ãƒ¢ãƒ¼ãƒ‰é¸æŠ ğŸ®</h2>
            <button class="mode-button" onclick="selectMode('kato')">
                <h3>ğŸ“˜ åŠ è—¤å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼‰</h3>
                <p>è«–ç†çš„ã™ãã‚‹æ•°å­¦æ•™å¸«ã¨ã—ã¦ã€ãªã¿å…ˆç”Ÿã¸ã®ç„¡è¬€ãªæŒ‘æˆ¦ï¼<br>
                â€»ãªã¿å…ˆç”Ÿæ”»ç•¥ã¯ä¸å¯èƒ½ã€‚ç•‘å…ˆç”Ÿã¨ã®çœŸå®Ÿã®æ„›ã‚’ç›®æŒ‡ã›ã€‚</p>
            </button>
            <button class="mode-button" onclick="selectMode('custom')">
                <h3>ğŸ’• ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰ï¼ˆç¦æ–­ã®æ‹ï¼‰</h3>
                <p>ä»Šæ—¥ã¯2æœˆ14æ—¥ã€ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒ‡ãƒ¼ï¼<br>
                ã‚ãªãŸã¯é’ç¨œä¸­å­¦æ ¡3å¹´ç”Ÿã€‚æ‹…ä»»ã®åŒ—äº•ãªã¿å…ˆç”Ÿã«æ‹ã‚’ã—ãŸ...ï¼<br>
                â€»ç”Ÿå¾’ã¨å…ˆç”Ÿã®ç¦æ–­ã®æ‹æ„›ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€‚</p>
            </button>
        </div>

        <!-- åå‰å…¥åŠ›ç”»é¢ -->
        <div id="name-input-screen">
            <h2>ğŸ’ ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ ğŸ’</h2>
            <div class="valentine-note">
                <p style="font-weight: bold; color: #ec407a; margin-bottom: 10px;">ğŸ“… 2æœˆ14æ—¥ ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒ‡ãƒ¼</p>
                <p>
                    ã‚ãªãŸã¯é’ç¨œä¸­å­¦æ ¡3å¹´ç”Ÿã€‚<br>
                    æ‹…ä»»ã§ã‚ã‚Šã€ç¾ä»£å›½èªã‚’æ•™ãˆã‚‹åŒ—äº•ãªã¿å…ˆç”Ÿã«<br>
                    å¯†ã‹ã«æ‹ã‚’ã—ã¦ã„ã‚‹...<br><br>
                    ä»Šæ—¥ã€å‹‡æ°—ã‚’å‡ºã—ã¦ãƒãƒ§ã‚³ã‚’æ¸¡ãã†ã¨æ±ºæ„ã—ãŸã€‚
                </p>
            </div>
            <input type="text" id="player-name-input" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ" maxlength="10">
            <br>
            <button class="start-button pink" onclick="startGameWithName()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen">
            <div id="game-header" class="game-header">Phase 1: å‹˜é•ã„ã®æ±‚æ„›</div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
            <div id="status-bar">
                <div class="stat">
                    <div class="stat-label" id="nami-label">ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦</div>
                    <div class="stat-value love" id="nami-affection">0</div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill love" id="nami-bar" style="width: 50%"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">å‹‡æ°—</div>
                    <div class="stat-value" id="san-value">100</div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill san" id="san-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div id="items"></div>
            </div>
            
            <div id="text-window" class="normal">
                <div id="math-effects"></div>
                <div id="character-portrait" class="character-portrait"></div>
                <div id="text-content"></div>
            </div>

            <div id="choices"></div>
            
            <!-- é€ƒèµ°åŠ‡ãƒãƒƒãƒ— -->
            <div id="escape-map">
                <div class="map-info">
                    æ¾æœ¬å…ˆç”Ÿã®ä½ç½®: <span class="map-danger" id="matsumoto-pos">???</span><br>
                    å®‰å…¨åœ°å¸¯ï¼ˆè·å“¡å®¤ï¼‰ã¾ã§é€ƒã’ã‚ï¼
                </div>
                <div id="map-grid"></div>
            </div>
            
            <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="input-section">
                <div id="timer"></div>
                <input type="text" id="excuse-input" placeholder="è«–ç†çš„ãªè¨€ã„è¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                <button class="submit-button" onclick="submitExcuse()">é€ä¿¡</button>
            </div>

            <!-- æ•°å¼ãƒŸãƒ‹ã‚²ãƒ¼ãƒ  -->
            <div id="math-game">
                <h3 id="math-game-title">åŠ è—¤å…ˆç”Ÿã®æ•°å­¦åŠ›ã§è§£æ±ºã›ã‚ˆï¼</h3>
                <div id="math-question"></div>
                <input type="number" id="math-input" placeholder="ç­”ãˆã‚’å…¥åŠ›">
                <button class="submit-button" onclick="submitMathAnswer()">å›ç­”</button>
            </div>
        </div>

        <!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="ending-screen"></div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            mode: 'kato',
            playerName: 'åŠ è—¤',
            currentPhase: 0,
            currentScene: 0,
            namiAffection: 0,
            courage: 100,
            items: [],
            playerPos: 4,
            matsumotoPos: 0,
            escapeTurns: 0,
            mathCorrect: 0
        };

        let timerInterval;
        let timeLeft = 15;
        let currentScenarios = [];

        function showModeSelect() {
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('mode-select').style.display = 'block';
        }

        function selectMode(mode) {
            gameState.mode = mode;
            document.getElementById('mode-select').style.display = 'none';
            
            if (mode === 'kato') {
                gameState.playerName = 'åŠ è—¤';
                startGame();
            } else {
                document.getElementById('name-input-screen').style.display = 'block';
            }
        }

        function startGameWithName() {
            const nameInput = document.getElementById('player-name-input').value.trim();
            if (nameInput.length === 0) {
                showNotification('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                return;
            }
            gameState.playerName = nameInput;
            document.getElementById('name-input-screen').style.display = 'none';
            startGame();
        }

        function startGame() {
            document.getElementById('game-screen').style.display = 'block';
            gameState.currentPhase = 1;
            gameState.currentScene = 0;
            gameState.namiAffection = gameState.mode === 'kato' ? 0 : 50;
            gameState.courage = 100;
            gameState.items = [];
            
            if (gameState.mode === 'kato') {
                document.getElementById('game-header').textContent = 'Phase 1: å‹˜é•ã„ã®æ±‚æ„›';
                document.getElementById('nami-label').textContent = 'ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦';
                currentScenarios = katoPhase1Scenarios;
            } else {
                document.getElementById('game-header').textContent = 'ğŸ’ 2æœˆ14æ—¥ ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒ‡ãƒ¼';
                document.getElementById('game-header').classList.add('valentine');
                document.getElementById('nami-label').textContent = 'ãªã¿å…ˆç”Ÿâ™¡å¥½æ„Ÿåº¦';
                document.querySelector('#status-bar .stat:nth-child(2) .stat-label').textContent = 'å‹‡æ°—';
                currentScenarios = studentValentineScenarios;
            }
            
            updateStatus();
            showScene();
        }

        // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ã‚·ãƒŠãƒªã‚ªï¼ˆåŠ è—¤å…ˆç”Ÿãªã—ï¼‰
        const studentValentineScenarios = [
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "2æœˆ14æ—¥ã€æœã€‚é’ç¨œä¸­å­¦æ ¡3å¹´ç”Ÿã®ã‚¯ãƒ©ã‚¹ã€‚ä»Šæ—¥ã¯ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒ‡ãƒ¼ã€‚",
                choices: null
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ï¼ˆé„ã®ä¸­ã®ãƒãƒ§ã‚³ã‚’ç¢ºèªã™ã‚‹ï¼‰...ã‚ˆã—ã€ã‚ã‚‹ã€‚ä»Šæ—¥ã“ãã€ãªã¿å…ˆç”Ÿã«æ¸¡ã™ã‚“ã ã€‚",
                innerThought: "ï¼ˆãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹...ã§ã‚‚ã€é ‘å¼µã‚‰ãªã„ã¨ï¼ï¼‰",
                choices: null,
                portrait: "ğŸ˜³",
                effects: true,
                effectType: 'chocolate'
            },
            {
                speaker: "å‹äººA",
                text: "ãŠã„ã€ãŠå‰ä»Šæ—¥èª°ã«ãƒãƒ§ã‚³æ¸¡ã™ã®ï¼Ÿ",
                choices: null,
                portrait: "ğŸ‘¦"
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ãˆã€ãˆã£ã¨...å†…ç·’ã€‚",
                choices: null,
                portrait: "ğŸ˜…"
            },
            {
                speaker: "å‹äººB",
                text: "ãªã‚“ã ã‚ˆã€œã€æ•™ãˆã¦ãã‚Œã‚ˆï¼ã¾ã•ã‹...ãªã¿å…ˆç”Ÿã¨ã‹ï¼Ÿ",
                choices: null,
                portrait: "ğŸ‘¦"
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "...ï¼ï¼ˆãƒãƒ¬ãŸï¼Ÿï¼‰",
                innerThought: "ï¼ˆé¡”ãŒç†±ã„...ï¼‰",
                choices: null,
                portrait: "ğŸ˜³"
            },
            {
                speaker: "å‹äººA",
                text: "ãƒã‚¸ã‹ã‚ˆï¼ãªã¿å…ˆç”Ÿã€ç¢ºã‹ã«å¯æ„›ã„ã‘ã©...å…ˆç”Ÿã ãï¼Ÿ",
                choices: null,
                portrait: "ğŸ‘¦"
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "...ã‚ã‹ã£ã¦ã‚‹ã‚ˆã€‚ã§ã‚‚ã€æ°—æŒã¡ã¯ä¼ãˆãŸã„ã‚“ã ã€‚",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãã®æ™‚ã€æ•™å®¤ã®ãƒ‰ã‚¢ãŒé–‹ã„ãŸã€‚æ‹…ä»»ã®åŒ—äº•ãªã¿å…ˆç”ŸãŒå…¥ã£ã¦ããŸã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€œï¼ä»Šæ—¥ã‚‚ã„ã„å¤©æ°—ã§ã™ã­â™ª",
                innerThought: "ï¼ˆä»Šæ—¥ã¯ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ã‹...èª°ã‹ãã‚Œã‚‹ã‹ãªï¼Ÿãˆã¸ã¸ï¼‰",
                choices: null,
                portrait: "ğŸ°",
                isNami: true,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ï¼ˆå¿ƒè‡“ãŒé«˜é³´ã‚‹ï¼‰",
                innerThought: "ï¼ˆå¯æ„›ã„...ä»Šæ—¥çµ¶å¯¾æ¸¡ã™...ï¼ï¼‰",
                choices: null,
                portrait: "ğŸ˜³"
            },
            {
                speaker: "ãªã¿",
                text: "ãã‚Œã§ã¯ã€1æ™‚é–“ç›®ã¯ç¾ä»£å›½èªã§ã™ã€‚æ•™ç§‘æ›¸ã‚’é–‹ã„ã¦ã€œ",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãªã¿å…ˆç”Ÿã®æˆæ¥­ãŒå§‹ã¾ã£ãŸã€‚ã„ã¤ã‚‚ã‚ˆã‚Šç·Šå¼µã—ã¦ã€å…¨ç„¶é›†ä¸­ã§ããªã„ã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: `ã¯ã„ã€ã˜ã‚ƒã‚æ¬¡ã®æ®µè½ã€${gameState.playerName}ãã‚“èª­ã‚“ã§ãã‚Œã‚‹ï¼Ÿ`,
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ã¯ã€ã¯ã„ï¼",
                choices: [
                    {
                        text: "Aï¼šã‚¹ãƒ©ã‚¹ãƒ©ã¨èª­ã‚€ï¼ˆé ‘å¼µã£ã¦é›†ä¸­ï¼‰",
                        result: 8,
                        isGood: true
                    },
                    {
                        text: "Bï¼šç·Šå¼µã—ã¦å™›ã¿ã¾ãã‚‹",
                        result: 3,
                        isGood: true
                    },
                    {
                        text: "Cï¼šå…ˆç”Ÿã‚’è¦‹ã¤ã‚ãªãŒã‚‰èª­ã‚€",
                        result: 5,
                        isGood: true
                    }
                ],
                portrait: "ğŸ˜…"
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã‚ŠãŒã¨ã†ï¼ä¸Šæ‰‹ã«èª­ã‚ã¦ãŸã‚ˆâ™ª",
                innerThought: "ï¼ˆä»Šæ—¥ã‚‚é ‘å¼µã£ã¦ã‚‹ãª...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true,
                affectionCheck: true
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "50åˆ†ã®æˆæ¥­ãŒçµ‚ã‚ã£ãŸã€‚ãƒãƒ£ã‚¤ãƒ ãŒé³´ã‚‹ã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ã¯ã„ã€ãã‚Œã§ã¯ã“ã“ã¾ã§ã€œï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ•™å®¤ãŒã–ã‚ã¤ãå§‹ã‚ã‚‹ã€‚ä»Šã ï¼ãƒãƒ§ã‚³ã‚’æ¸¡ã™ãªã‚‰ä»Šã—ã‹ãªã„ï¼",
                choices: null,
                effects: true,
                effectType: 'chocolate'
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ï¼ˆç«‹ã¡ä¸ŠãŒã‚Šã€æ•™å£‡ã«å‘ã‹ã†ï¼‰",
                innerThought: "ï¼ˆç·Šå¼µã™ã‚‹...ã§ã‚‚ã€è¡Œãã‚“ã ï¼ï¼‰",
                choices: null,
                portrait: "ğŸ˜³",
                courage: -10
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã‚Œã€ã©ã†ã—ãŸã®ï¼Ÿè³ªå•ï¼Ÿ",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ã‚ã€ã‚ã®...å…ˆç”Ÿ...ï¼",
                choices: [
                    {
                        text: "Aï¼šã€Œã“ã‚Œ...å—ã‘å–ã£ã¦ãã ã•ã„ï¼ã€ï¼ˆãƒãƒ§ã‚³ã‚’å·®ã—å‡ºã™ï¼‰",
                        result: 15,
                        isGood: true,
                        chocolateGive: true
                    },
                    {
                        text: "Bï¼šã€Œã‚ã€ã‚„ã£ã±ã‚Šãªã‚“ã§ã‚‚ãªã„ã§ã™...ã€ï¼ˆå¼•ã£è¾¼ã‚€ï¼‰",
                        result: 0,
                        isGood: false
                    },
                    {
                        text: "Cï¼šã€Œå…ˆç”Ÿã€å¥½ãã§ã™ï¼ã“ã‚Œï¼ã€ï¼ˆå¤§å£°ã§ï¼‰",
                        result: 10,
                        isGood: true,
                        chocolateGive: true,
                        bold: true
                    }
                ],
                portrait: "ğŸ˜³"
            }
        ];

        const studentValentineAfterChoco = [
            {
                speaker: "ãªã¿",
                text: "ãˆã€ã‚ã‚ŠãŒã¨ã†ï¼",
                innerThought: "ï¼ˆå¬‰ã—ã„...ï¼ã§ã‚‚ã€ç”Ÿå¾’ã‹ã‚‰...ã©ã†ã—ã‚ˆã†...ï¼‰",
                choices: null,
                portrait: "ğŸ˜³",
                isNami: true,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãªã¿å…ˆç”Ÿã¯å°‘ã—å›°ã£ãŸã‚ˆã†ãªã€ã§ã‚‚å¬‰ã—ãã†ãªç¬‘é¡”ã‚’è¦‹ã›ãŸã€‚",
                choices: null
            },
            {
                speaker: "å‹äººA",
                text: "ï¼ˆå°å£°ï¼‰ãƒã‚¸ã§æ¸¡ã—ãŸã‚ˆ...ï¼",
                choices: null,
                portrait: "ğŸ‘¦"
            },
            {
                speaker: "å‹äººB",
                text: "ï¼ˆå°å£°ï¼‰ãªã¿å…ˆç”Ÿã€å¬‰ã—ãã†ã ã£ãŸãª...ã€",
                choices: null,
                portrait: "ğŸ‘¦"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æˆæ¥­ãŒçµ‚ã‚ã‚Šã€æ˜¼ä¼‘ã¿ã€‚ãªã¿å…ˆç”Ÿã¯è·å“¡å®¤ã«ã„ã‚‹ã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ï¼ˆãƒãƒ§ã‚³ã‚’è¦‹ãªãŒã‚‰ï¼‰ã‚„ã£ãŸãƒ¼...ï¼",
                innerThought: "ï¼ˆå¬‰ã—ã„ãª...ã§ã‚‚ã€å…ˆç”Ÿã¨ç”Ÿå¾’ã ã—...ã©ã†ã—ã‚ˆã†...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: "å¤§è°·",
                text: "ãªã¿å…ˆç”Ÿã€ä½•è¦‹ã¦ãƒ‹ãƒ¤ãƒ‹ãƒ¤ã—ã¦ã‚‹ã®ï¼Ÿ",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãªã¿",
                text: "ãˆã€ãˆã£ã¨...ãªã‚“ã§ã‚‚ãªã„ã§ã™ï¼",
                innerThought: "ï¼ˆè¦‹ã‚‰ã‚ŒãŸ...æ¥ãšã‹ã—ã„...ï¼‰",
                choices: null,
                portrait: "ğŸ˜³",
                isNami: true
            },
            {
                speaker: "å¤§è°·",
                text: "ã‚‚ã—ã‹ã—ã¦ç”Ÿå¾’ã‹ã‚‰ãƒãƒ§ã‚³ã‚‚ã‚‰ã£ãŸã¨ã‹ï¼Ÿè‰¯ã‹ã£ãŸã˜ã‚ƒã‚“ï¼",
                choices: null,
                portrait: "ğŸ˜„"
            },
            {
                speaker: "ãªã¿",
                text: "ãã€ãã†ãªã‚“ã§ã™...ãˆã¸ã¸â™ª",
                innerThought: "ï¼ˆå¤§è°·å…ˆç”Ÿã«ãƒãƒ¬ã¡ã‚ƒã£ãŸ...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ”¾èª²å¾Œã€‚ã‚ãªãŸã¯å»Šä¸‹ã§ãªã¿å…ˆç”Ÿã¨å¶ç„¶ä¼šã£ãŸã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: `ã‚ã€${gameState.playerName}ãã‚“...`,
                innerThought: "ï¼ˆãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "å…ˆç”Ÿ...ã‚ã®ã€ãƒãƒ§ã‚³...",
                choices: null,
                portrait: "ğŸ˜³"
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã‚ŠãŒã¨ã†...ã™ã”ãå¬‰ã—ã‹ã£ãŸã€‚",
                innerThought: "ï¼ˆã§ã‚‚ã€ç§ã¯å…ˆç”Ÿã§...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ä¿º...å…ˆç”Ÿã®ã“ã¨ãŒ...",
                choices: [
                    {
                        text: "Aï¼šã€Œå¥½ãã§ã™ï¼ä»˜ãåˆã£ã¦ãã ã•ã„ï¼ã€",
                        result: 15,
                        isGood: true
                    },
                    {
                        text: "Bï¼šã€Œå°Šæ•¬ã—ã¦ã¾ã™...ã€ï¼ˆå‘Šç™½ã‚’é¿ã‘ã‚‹ï¼‰",
                        result: 5,
                        isGood: false
                    },
                    {
                        text: "Cï¼šã€Œãšã£ã¨è¦‹å®ˆã£ã¦ã¦ã„ã„ã§ã™ã‹ï¼Ÿã€",
                        result: 10,
                        isGood: true
                    }
                ],
                portrait: "ğŸ˜³"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãªã¿å…ˆç”Ÿã®å¥½æ„Ÿåº¦ãŒã€ã‚ãªãŸã®é‹å‘½ã‚’æ±ºã‚ã‚‹...ï¼",
                choices: null,
                finalCheck: true
            }
        ];

        const studentValentineRetreat = [
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "çµå±€ã€ãƒãƒ§ã‚³ã‚’æ¸¡ã›ãªã‹ã£ãŸ...",
                choices: null
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ï¼ˆè‡ªåˆ†ã®å¸­ã«æˆ»ã‚‹ï¼‰",
                innerThought: "ï¼ˆ...å‹‡æ°—ãŒå‡ºãªã‹ã£ãŸ...ï¼‰",
                choices: null,
                portrait: "ğŸ˜",
                courage: -20
            },
            {
                speaker: "å‹äººA",
                text: "ãŠã„ã€æ¸¡ã•ãªã‹ã£ãŸã®ã‹ï¼Ÿ",
                choices: null,
                portrait: "ğŸ‘¦"
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "...ã†ã‚“ã€‚ã‚„ã£ã±ã‚Šç„¡ç†ã ã£ãŸã€‚",
                choices: null,
                portrait: "ğŸ˜"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãã®æ—¥ã€ãªã¿å…ˆç”Ÿã¯ä»–ã®ç”·å­ç”Ÿå¾’ãŸã¡ã‹ã‚‰ãŸãã•ã‚“ã®ãƒãƒ§ã‚³ã‚’ã‚‚ã‚‰ã£ã¦ã„ãŸã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ã¿ã‚“ãªã‚ã‚ŠãŒã¨ã†ã€œï¼å¬‰ã—ã„ãªâ™ª",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ï¼ˆé ãã‹ã‚‰è¦‹ã¦ã„ã‚‹ï¼‰",
                innerThought: "ï¼ˆ...ä¿ºã‚‚æ¸¡ã›ã°ã‚ˆã‹ã£ãŸ...ï¼‰",
                choices: null,
                portrait: "ğŸ˜"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "å‹‡æ°—ãŒè¶³ã‚Šãªã‹ã£ãŸ...Bad Endã¸ã€‚",
                choices: null
            }
        ];

        // åŠ è—¤å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã®ã‚·ãƒŠãƒªã‚ªï¼ˆç°¡ç•¥ç‰ˆï¼‰
        const katoPhase1Scenarios = [
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "è·å“¡å®¤ã€‚æ•°å­¦æ•™å¸«ãƒ»åŠ è—¤å…ˆç”Ÿã¯é’ãƒšãƒ³ã‚’æ¡ã‚Šã—ã‚ã¦ã„ãŸã€‚",
                choices: null
            },
            {
                speaker: "åŠ è—¤",
                text: "ï¼ˆæ€è€ƒä¸­ï¼‰åŒ—äº•ãªã¿å…ˆç”Ÿã¨ã®é©åˆç‡...92.4%ã€‚å®Œç’§ãªè«–ç†ã ã€‚",
                choices: null,
                effects: true,
                portrait: "ğŸ§®"
            },
            // ã“ã“ã«æ®‹ã‚Šã®katoPhase1Scenariosã‚’è¿½åŠ 
            // çœç•¥ã—ã¾ã™ãŒã€å®Ÿè£…æ™‚ã«ã¯å‰å›ã®ã‚·ãƒŠãƒªã‚ªã‚’ä½¿ç”¨
        ];

        function updateStatus() {
            const statValue = gameState.namiAffection;
            const courageValue = gameState.courage;
            
            document.getElementById('nami-affection').textContent = statValue;
            document.getElementById('san-value').textContent = courageValue;
            
            const namiBar = document.getElementById('nami-bar');
            const sanBar = document.getElementById('san-bar');
            
            const namiPercent = gameState.mode === 'kato' 
                ? Math.max(0, Math.min(100, 50 + gameState.namiAffection))
                : Math.max(0, Math.min(100, gameState.namiAffection));
            
            namiBar.style.width = namiPercent + '%';
            sanBar.style.width = courageValue + '%';
            
            if (courageValue < 30) {
                document.getElementById('san-value').classList.add('danger');
            }
            
            // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º
            const itemsDiv = document.getElementById('items');
            itemsDiv.innerHTML = '';
            gameState.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                if (item.includes('ãƒãƒ§ã‚³')) {
                    itemDiv.classList.add('chocolate');
                }
                itemDiv.textContent = item;
                itemsDiv.appendChild(itemDiv);
            });
        }

        function showScene() {
            const textWindow = document.getElementById('text-window');
            const textContent = document.getElementById('text-content');
            const choicesDiv = document.getElementById('choices');
            const mathEffects = document.getElementById('math-effects');
            const portraitDiv = document.getElementById('character-portrait');

            choicesDiv.innerHTML = '';
            choicesDiv.style.display = 'none';
            mathEffects.innerHTML = '';
            portraitDiv.textContent = '';

            let scene = currentScenarios[gameState.currentScene];

            if (!scene) {
                if (gameState.mode === 'kato') {
                    normalEnding();
                } else {
                    if (!gameState.items.includes('ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒãƒ§ã‚³')) {
                        currentScenarios = studentValentineRetreat;
                        gameState.currentScene = 0;
                        showScene();
                    } else {
                        checkStudentEnding();
                    }
                }
                return;
            }

            if (scene.finalCheck) {
                checkStudentEnding();
                return;
            }

            if (scene.affectionCheck && gameState.mode === 'custom') {
                setTimeout(() => {
                    if (gameState.namiAffection > 60) {
                        showNotification('ğŸ’– ãªã¿å…ˆç”Ÿã®å¥½æ„Ÿåº¦ãŒä¸ŠãŒã£ãŸï¼', 'love');
                    }
                }, 500);
            }

            if (gameState.mode === 'custom') {
                textWindow.classList.remove('normal');
                textWindow.classList.add('valentine');
            }

            if (scene.portrait) {
                portraitDiv.textContent = scene.portrait;
            }

            if (scene.effects) {
                const effectType = scene.effectType || 'math';
                if (effectType === 'heart') {
                    const symbols = ['ğŸ’•', 'ğŸ’–', 'ğŸ’—', 'ğŸ’˜', 'ğŸ’', 'â¤ï¸', 'ğŸ’“'];
                    for (let i = 0; i < 8; i++) {
                        const symbol = document.createElement('div');
                        symbol.className = 'heart-symbol';
                        symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                        symbol.style.left = Math.random() * 80 + '%';
                        symbol.style.top = Math.random() * 80 + '%';
                        symbol.style.animationDelay = Math.random() * 2 + 's';
                        mathEffects.appendChild(symbol);
                    }
                } else if (effectType === 'chocolate') {
                    const symbols = ['ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ’'];
                    for (let i = 0; i < 8; i++) {
                        const symbol = document.createElement('div');
                        symbol.className = 'chocolate-symbol';
                        symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                        symbol.style.left = Math.random() * 80 + '%';
                        symbol.style.top = Math.random() * 80 + '%';
                        symbol.style.animationDelay = Math.random() * 2 + 's';
                        mathEffects.appendChild(symbol);
                    }
                }
            }

            const speakerClass = scene.isNami ? 'nami' : (scene.speaker === gameState.playerName ? 'player' : '');
            let html = `<span class="character-name ${speakerClass}">${scene.speaker}</span>${scene.text}`;
            
            if (scene.innerThought) {
                html += `<div class="inner-thought">${scene.innerThought}</div>`;
            }
            
            textContent.innerHTML = html;

            if (scene.courage) {
                gameState.courage = Math.max(0, Math.min(100, gameState.courage + scene.courage));
                updateStatus();
            }

            if (scene.choices) {
                setTimeout(() => {
                    choicesDiv.style.display = 'block';
                    scene.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-button romance';
                        button.textContent = choice.text;
                        button.onclick = () => makeChoice(index, choice);
                        choicesDiv.appendChild(button);
                    });
                }, 500);
            } else {
                setTimeout(() => {
                    choicesDiv.style.display = 'block';
                    const button = document.createElement('button');
                    button.className = 'continue-button romance';
                    button.textContent = 'æ¬¡ã¸';
                    button.onclick = nextScene;
                    choicesDiv.appendChild(button);
                }, 500);
            }
        }

        function makeChoice(index, choice) {
            if (choice.result) {
                gameState.namiAffection += choice.result;
                if (gameState.mode === 'custom') {
                    const notifType = choice.isGood ? 'love' : '';
                    const message = choice.isGood ? 
                        `ãªã¿å…ˆç”Ÿã®å¥½æ„Ÿåº¦ãŒä¸ŠãŒã£ãŸï¼ (+${choice.result})` : 
                        `ãªã¿å…ˆç”Ÿã®åå¿œãŒå¾®å¦™...`;
                    showNotification(message, notifType);
                }
            }
            
            if (choice.chocolateGive) {
                gameState.items.push('ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒãƒ§ã‚³');
                updateStatus();
                currentScenarios = studentValentineAfterChoco;
                gameState.currentScene = -1;
            }
            
            updateStatus();
            playSound();
            nextScene();
        }

        function nextScene() {
            gameState.currentScene++;
            showScene();
        }

        function checkStudentEnding() {
            if (gameState.namiAffection >= 75) {
                studentTrueEnding();
            } else if (gameState.namiAffection >= 60) {
                studentGoodEnding();
            } else if (gameState.namiAffection >= 40) {
                studentNormalEnding();
            } else {
                studentBadEnding();
            }
        }

        function studentTrueEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'nami';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ°ğŸ’•</div>
                <h2>ğŸ’ True Love Endï¼šç¦æ–­ã®æ‹ã€æˆå°± ğŸ’</h2>
                <p><strong>${gameState.playerName}:</strong> ã€Œå¥½ãã§ã™ï¼ä»˜ãåˆã£ã¦ãã ã•ã„ï¼ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œ...${gameState.playerName}ãã‚“ã€</p>
                <p>ãªã¿å…ˆç”Ÿã¯å›°ã£ãŸé¡”ã‚’ã—ãªãŒã‚‰ã‚‚ã€å¾®ç¬‘ã‚“ã ã€‚</p>
                <p><strong>ãªã¿:</strong> ã€Œç§ã‚‚...å®Ÿã¯ã€${gameState.playerName}ãã‚“ã®ã“ã¨...æ°—ã«ãªã£ã¦ãŸã€</p>
                <p><strong>${gameState.playerName}:</strong> ã€Œæœ¬å½“ã§ã™ã‹...ï¼ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œã§ã‚‚ã€ç§ã¯å…ˆç”Ÿã§ã€${gameState.playerName}ãã‚“ã¯ç”Ÿå¾’ã ã‹ã‚‰...å’æ¥­ã™ã‚‹ã¾ã§å¾…ã£ã¦ãã‚Œã‚‹ï¼Ÿã€</p>
                <p><strong>${gameState.playerName}:</strong> ã€Œã‚‚ã¡ã‚ã‚“ã§ã™ï¼ã€</p>
                <p>1ãƒ¶æœˆå¾Œã€é’ç¨œä¸­å­¦æ ¡ã®å’æ¥­å¼ã€‚</p>
                <p><strong>ãªã¿:</strong> ã€Œå’æ¥­ãŠã‚ã§ã¨ã†ã€‚ã“ã‚Œã§ã€ã‚‚ã†å…ˆç”Ÿã¨ç”Ÿå¾’ã˜ã‚ƒãªã„ã­ã€</p>
                <p>äºŒäººã¯æ‰‹ã‚’ç¹‹ãã€æ–°ã—ã„äººç”Ÿã‚’æ­©ã¿å§‹ã‚ãŸã€‚</p>
                <p style="font-size: 48px; margin: 20px 0;">ğŸ’• HAPPY END ğŸ’•</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                å‹‡æ°—: ${gameState.courage}
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function studentGoodEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'nami';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ°ğŸ˜Š</div>
                <h2>ğŸ’— Good Endï¼šå„ªã—ã„å…ˆç”Ÿ ğŸ’—</h2>
                <p><strong>${gameState.playerName}:</strong> ã€Œå¥½ãã§ã™ï¼ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œ...ã‚ã‚ŠãŒã¨ã†ã€‚å¬‰ã—ã„ã‚ˆã€</p>
                <p>ãªã¿å…ˆç”Ÿã¯å„ªã—ãå¾®ç¬‘ã‚“ã ã€‚</p>
                <p><strong>ãªã¿:</strong> ã€Œã§ã‚‚ã€ç§ã¯å…ˆç”Ÿã ã‹ã‚‰...æ‹äººã«ã¯ãªã‚Œãªã„ã®ã€‚ã”ã‚ã‚“ã­ã€</p>
                <p><strong>${gameState.playerName}:</strong> ã€Œ...ãã†ã§ã™ã‚ˆã­ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œã§ã‚‚ã€${gameState.playerName}ãã‚“ã®æ°—æŒã¡ã¯å¬‰ã—ã‹ã£ãŸã€‚å¤§åˆ‡ãªç”Ÿå¾’ã ã‚ˆã€</p>
                <p>å’æ¥­å¾Œã‚‚ã€ãªã¿å…ˆç”Ÿã¨ã¯è‰¯ã„é–¢ä¿‚ãŒç¶šã„ãŸã€‚<br>
                æ™‚ã€…é’ç¨œä¸­å­¦æ ¡ã«éŠã³ã«è¡Œãã¨ã€ãªã¿å…ˆç”Ÿã¯å¤‰ã‚ã‚‰ãšå„ªã—ãè¿ãˆã¦ãã‚Œã‚‹ã€‚</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                å‹‡æ°—: ${gameState.courage}<br>
                â€»å¥½æ„Ÿåº¦75ä»¥ä¸Šã§True Endã«åˆ°é”ã§ãã¾ã™
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function studentNormalEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'normal';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ°</div>
                <h2>Normal Endï¼šã»ã‚è‹¦ã„ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³</h2>
                <p><strong>${gameState.playerName}:</strong> ã€Œå¥½ãã§ã™...ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œ...ã”ã‚ã‚“ã­ã€‚æ°—æŒã¡ã¯å¬‰ã—ã„ã‘ã©ã€å…ˆç”Ÿã¨ç”Ÿå¾’ã ã‹ã‚‰ã€</p>
                <p>ãªã¿å…ˆç”Ÿã¯ç”³ã—è¨³ãªã•ãã†ã«å¾®ç¬‘ã‚“ã ã€‚</p>
                <p><strong>ãªã¿:</strong> ã€Œã§ã‚‚ã€ãƒãƒ§ã‚³ã¯ã‚ã‚ŠãŒã¨ã†ã€‚å¤§åˆ‡ã«ã™ã‚‹ã­ã€</p>
                <p>ãã®å¾Œã€ãªã¿å…ˆç”Ÿã¨ã®é–¢ä¿‚ã¯å¤‰ã‚ã‚‰ãªã‹ã£ãŸã€‚<br>
                é’ç¨œä¸­å­¦æ ¡ã®å’æ¥­ã¾ã§ã€æ™®é€šã®å…ˆç”Ÿã¨ç”Ÿå¾’ã¨ã—ã¦éã”ã—ãŸã€‚</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                å‹‡æ°—: ${gameState.courage}
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function studentBadEnding() {
            if (!gameState.items.includes('ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒãƒ§ã‚³')) {
                document.getElementById('game-screen').style.display = 'none';
                const endingScreen = document.getElementById('ending-screen');
                endingScreen.className = 'bad';
                endingScreen.style.display = 'block';
                endingScreen.innerHTML = `
                    <div class="character-portrait">ğŸ˜</div>
                    <h2>Bad Endï¼šæ¸¡ã›ãªã‹ã£ãŸãƒãƒ§ã‚³</h2>
                    <p>çµå±€ã€å‹‡æ°—ãŒå‡ºã›ãšã«ãƒãƒ§ã‚³ã‚’æ¸¡ã›ãªã‹ã£ãŸã€‚</p>
                    <p>ãã®æ—¥ã®æ”¾èª²å¾Œã€ãªã¿å…ˆç”Ÿã¯ä»–ã®ç”Ÿå¾’ãŸã¡ã‹ã‚‰ã‚‚ã‚‰ã£ãŸãƒãƒ§ã‚³ã‚’å¬‰ã—ãã†ã«è¦‹ã¦ã„ãŸã€‚</p>
                    <p><strong>${gameState.playerName}:</strong> ã€Œï¼ˆé ãã‹ã‚‰è¦‹ã¦ã„ã‚‹ï¼‰...æ¸¡ã›ã°ã‚ˆã‹ã£ãŸã€</p>
                    <p>é’ç¨œä¸­å­¦æ ¡ã®å’æ¥­ã¾ã§ã€ã“ã®å¾Œæ‚”ã¯æ¶ˆãˆã‚‹ã“ã¨ã¯ãªã‹ã£ãŸ...</p>
                    <p style="margin-top: 20px; font-size: 14px; color: #666;">
                    æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                    ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                    å‹‡æ°—: ${gameState.courage}<br>
                    â€»ãƒãƒ§ã‚³ã‚’æ¸¡ã•ãªã‹ã£ãŸãŸã‚ã€Bad Endã«ãªã‚Šã¾ã—ãŸ
                    </p>
                    <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
                `;
            } else {
                document.getElementById('game-screen').style.display = 'none';
                const endingScreen = document.getElementById('ending-screen');
                endingScreen.className = 'bad';
                endingScreen.style.display = 'block';
                endingScreen.innerHTML = `
                    <div class="character-portrait">ğŸ˜°</div>
                    <h2>Bad Endï¼šå›°æƒ‘ã®å‘Šç™½</h2>
                    <p><strong>${gameState.playerName}:</strong> ã€Œå¥½ãã§ã™ï¼ã€</p>
                    <p><strong>ãªã¿:</strong> ã€Œãˆ...ãˆãˆã£ï¼ï¼Ÿã€</p>
                    <p>ãªã¿å…ˆç”Ÿã¯æ˜ã‚‰ã‹ã«å›°æƒ‘ã—ãŸè¡¨æƒ…ã‚’è¦‹ã›ãŸã€‚</p>
                    <p><strong>ãªã¿:</strong> ã€Œã”ã€ã”ã‚ã‚“ã­...ãã†ã„ã†ã¤ã‚‚ã‚Šã˜ã‚ƒãªãã¦...ãƒãƒ§ã‚³ã¯ç¾©ç†ã§...ã€</p>
                    <p>ãã®å¾Œã€ãªã¿å…ˆç”Ÿã¨ã¯ãã“ã¡ãªã„é–¢ä¿‚ãŒç¶šã„ãŸã€‚<br>
                    é’ç¨œä¸­å­¦æ ¡ã®å’æ¥­ã¾ã§ã€æ°—ã¾ãšã„æ€ã„ã‚’ã™ã‚‹ã“ã¨ã«ãªã£ãŸ...</p>
                    <p style="margin-top: 20px; font-size: 14px; color: #666;">
                    æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                    ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                    å‹‡æ°—: ${gameState.courage}<br>
                    â€»å¥½æ„Ÿåº¦ãŒä½ã™ãã¾ã—ãŸã€‚ã‚‚ã£ã¨è‰¯ã„é¸æŠè‚¢ã‚’é¸ã¼ã†ï¼
                    </p>
                    <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
                `;
            }
        }

        function normalEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'normal';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ˜”</div>
                <h2>End Aï¼šè¨ˆç®—é•ã„ã®å­¤ç‹¬</h2>
                <p>åŠ è—¤å…ˆç”Ÿã®ç‰©èª...</p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function showNotification(message, type = '') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = type;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        function playSound() {
            console.log('ã‚«ãƒãƒƒï¼ˆãƒœãƒ¼ãƒ«ãƒšãƒ³ã®ãƒãƒƒã‚¯éŸ³ï¼‰');
        }
    </script>
</body>
</html>