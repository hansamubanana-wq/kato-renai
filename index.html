<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ‹ã®åå·®å€¤ã‚¨ãƒ©ãƒ¼ ã€œåŠ è—¤å…ˆç”Ÿã€è¨ˆç®—ãŒåˆã„ã¾ã›ã‚“ï¼ã€œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
        }

        #title-screen {
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            position: relative;
        }

        #title-screen h1 {
            font-size: 24px;
            color: #1565c0;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        #title-screen h2 {
            font-size: 18px;
            color: #1976d2;
            margin-bottom: 30px;
        }

        #title-screen .concept {
            font-size: 16px;
            color: #424242;
            font-weight: bold;
            margin-bottom: 20px;
            font-style: italic;
        }

        #title-screen .description {
            font-size: 14px;
            color: #616161;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
        #mode-select {
            display: none;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(180deg, #fff9c4 0%, #fff59d 100%);
        }

        #mode-select h2 {
            font-size: 22px;
            color: #f57f17;
            margin-bottom: 30px;
        }

        .mode-button {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin: 15px auto;
            background: white;
            border: 3px solid #fbc02d;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
        }

        .mode-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(251, 192, 45, 0.3);
        }

        .mode-button h3 {
            font-size: 20px;
            color: #f57f17;
            margin-bottom: 10px;
        }

        .mode-button p {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        /* åå‰å…¥åŠ› */
        #name-input-screen {
            display: none;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(180deg, #fce4ec 0%, #f8bbd0 100%);
        }

        #name-input-screen h2 {
            font-size: 22px;
            color: #c2185b;
            margin-bottom: 20px;
        }

        #name-input-screen input {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ec407a;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .start-button {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
        }

        .start-button:active {
            transform: scale(0.95);
        }

        .start-button.pink {
            background: linear-gradient(135deg, #ec407a, #d81b60);
        }

        #game-screen {
            display: none;
        }

        .game-header {
            background: #1976d2;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        .game-header.romance {
            background: linear-gradient(135deg, #ec407a, #f48fb1);
        }

        .game-header.horror {
            background: linear-gradient(135deg, #ec407a, #ab47bc);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        #status-bar {
            background: white;
            padding: 15px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat {
            flex: 1;
            min-width: 100px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
        }

        .stat-value.danger {
            color: #d32f2f;
        }

        .stat-value.love {
            color: #ec407a;
        }

        .stat-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            transition: width 0.5s;
        }

        .stat-bar-fill.love {
            background: linear-gradient(90deg, #ec407a, #f48fb1);
        }

        .stat-bar-fill.san {
            background: linear-gradient(90deg, #d32f2f, #f44336);
        }

        #items {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .item {
            padding: 5px 10px;
            background: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 5px;
            font-size: 12px;
        }

        #text-window {
            min-height: 250px;
            padding: 30px 20px;
            background: #f5f5f5;
            position: relative;
            overflow: hidden;
        }

        #text-window.normal {
            background: repeating-linear-gradient(
                0deg,
                #e3f2fd,
                #e3f2fd 30px,
                #90caf9 30px,
                #90caf9 31px
            );
        }

        #text-window.romance {
            background: repeating-linear-gradient(
                0deg,
                #fce4ec,
                #fce4ec 30px,
                #f8bbd0 30px,
                #f8bbd0 31px
            );
        }

        #text-window.horror {
            background: repeating-linear-gradient(
                45deg,
                #fce4ec,
                #fce4ec 30px,
                #f8bbd0 30px,
                #f8bbd0 31px
            );
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* ã‚­ãƒ£ãƒ©ç«‹ã¡çµµé¢¨ */
        .character-portrait {
            text-align: center;
            font-size: 80px;
            margin: 10px 0;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #text-content {
            font-size: 16px;
            line-height: 1.8;
            color: #212121;
            position: relative;
            z-index: 2;
        }

        .character-name {
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 10px;
            display: block;
        }

        .character-name.nami {
            color: #ec407a;
        }

        .character-name.horror {
            color: #c2185b;
        }

        .inner-thought {
            font-style: italic;
            color: #999;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
        }

        #math-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .math-symbol {
            position: absolute;
            font-size: 24px;
            color: rgba(25, 118, 210, 0.2);
            animation: float 3s infinite;
        }

        /* ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .heart-symbol {
            position: absolute;
            font-size: 24px;
            color: rgba(236, 64, 122, 0.3);
            animation: floatHeart 3s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        @keyframes floatHeart {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.2); }
        }

        #choices {
            padding: 20px;
            background: white;
        }

        .choice-button {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #1976d2;
            border-radius: 10px;
            font-size: 15px;
            color: #1565c0;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            line-height: 1.5;
        }

        .choice-button:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .choice-button:active {
            transform: scale(0.98);
        }

        .choice-button.romance {
            border-color: #ec407a;
            color: #c2185b;
        }

        .choice-button.romance:hover {
            background: #fce4ec;
        }

        .choice-button.horror {
            border-color: #ab47bc;
            color: #8e24aa;
        }

        .choice-button.horror:hover {
            background: #f3e5f5;
        }

        .choice-result {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .choice-result.good {
            color: #4caf50;
        }

        .choice-result.bad {
            color: #f44336;
        }

        .continue-button {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .continue-button.romance {
            background: linear-gradient(135deg, #ec407a, #f48fb1);
        }

        /* é€ƒèµ°åŠ‡ãƒãƒƒãƒ— */
        #escape-map {
            display: none;
            padding: 20px;
            background: white;
        }

        #map-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .map-cell {
            aspect-ratio: 1;
            border: 2px solid #ec407a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .map-cell.player {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .map-cell.matsumoto {
            background: #fce4ec;
            animation: glow 1s infinite;
        }

        .map-cell.safe {
            background: #f1f8e9;
            border-color: #689f38;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px #ec407a; }
            50% { box-shadow: 0 0 20px #ec407a; }
        }

        .map-info {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .map-danger {
            color: #d32f2f;
            font-weight: bold;
        }

        /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        #input-section {
            display: none;
            padding: 20px;
            background: white;
        }

        #input-section input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ec407a;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        #timer {
            text-align: center;
            font-size: 24px;
            color: #c2185b;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .submit-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ec407a, #ab47bc);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        /* æ•°å¼ãƒŸãƒ‹ã‚²ãƒ¼ãƒ  */
        #math-game {
            display: none;
            padding: 20px;
            background: white;
            text-align: center;
        }

        #math-question {
            font-size: 24px;
            font-weight: bold;
            color: #1565c0;
            margin: 20px 0;
        }

        #math-input {
            width: 200px;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #1976d2;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        /* ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° */
        #ending-screen {
            display: none;
            padding: 40px 20px;
            text-align: center;
            min-height: 400px;
        }

        #ending-screen.normal {
            background: linear-gradient(180deg, #e3f2fd 0%, #90caf9 100%);
        }

        #ending-screen.bad {
            background: linear-gradient(180deg, #fce4ec 0%, #f8bbd0 100%);
        }

        #ending-screen.true {
            background: linear-gradient(180deg, #fff9c4 0%, #fff59d 100%);
        }

        #ending-screen.nami {
            background: linear-gradient(180deg, #fce4ec 0%, #f8bbd0 50%, #fff9c4 100%);
        }

        #ending-screen h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #ending-screen p {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .restart-button {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
        }

        /* é€šçŸ¥ */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        #notification.love {
            background: rgba(236, 64, 122, 0.9);
        }

        @media (max-width: 400px) {
            #title-screen h1 {
                font-size: 20px;
            }
            
            #text-content {
                font-size: 14px;
            }
            
            .choice-button {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="notification"></div>
    
    <div id="game-container">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen">
            <h1>æ‹ã®åå·®å€¤ã‚¨ãƒ©ãƒ¼</h1>
            <h2>ã€œåŠ è—¤å…ˆç”Ÿã€è¨ˆç®—ãŒåˆã„ã¾ã›ã‚“ï¼ã€œ</h2>
            <div class="concept">ã€Œæ„›ã¯è«–ç†ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã§ã¯è§£ã‘ãªã„ã€‚ã€</div>
            <div class="description">
                è«–ç†çš„æ€è€ƒã¨é’ãƒšãƒ³ã‚’æ­¦å™¨ã«ç”Ÿãã‚‹å …ç‰©æ•°å­¦æ•™å¸«ãƒ»åŠ è—¤ãŒã€<br>
                ã€Œæ‹æ„›ã€ã¨ã„ã†æœ€å¤§ã®éè«–ç†çš„èª²é¡Œã«æŒ‘ã‚€ã€‚<br>
                è‹¥æ‰‹äººæ°—æ•™å¸«ã¸ã®å‹˜é•ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€<br>
                è‚‰é£Ÿç³»ãŠã°ã•ã‚“æ•™å¸«ã‹ã‚‰ã®ãƒ›ãƒ©ãƒ¼ãªé€ƒèµ°åŠ‡ã€<br>
                ãã—ã¦éš£å¸­ã®ç†Ÿå¹´æ•™å¸«ã¨ã®çœŸå®Ÿã®æ„›ã€‚
            </div>
            <button class="start-button" onclick="showModeSelect()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ -->
        <div id="mode-select">
            <h2>ğŸ® ãƒ¢ãƒ¼ãƒ‰é¸æŠ ğŸ®</h2>
            <button class="mode-button" onclick="selectMode('kato')">
                <h3>ğŸ“˜ åŠ è—¤å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼‰</h3>
                <p>è«–ç†çš„ã™ãã‚‹æ•°å­¦æ•™å¸«ã¨ã—ã¦ã€ãªã¿å…ˆç”Ÿã¸ã®ç„¡è¬€ãªæŒ‘æˆ¦ï¼<br>
                â€»ãªã¿å…ˆç”Ÿæ”»ç•¥ã¯ä¸å¯èƒ½ã€‚ç•‘å…ˆç”Ÿã¨ã®çœŸå®Ÿã®æ„›ã‚’ç›®æŒ‡ã›ã€‚</p>
            </button>
            <button class="mode-button" onclick="selectMode('custom')">
                <h3>ğŸ’• æ‹æ„›ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒãƒ¼ãƒãƒ«ï¼‰</h3>
                <p>ã‚ãªãŸè‡ªèº«ã®åå‰ã§ã€ãªã¿å…ˆç”Ÿã‚’æ”»ç•¥ã§ãã‚‹æ­£çµ±æ´¾æ‹æ„›ã‚²ãƒ¼ãƒ ï¼<br>
                â€»é©åˆ‡ãªé¸æŠã§ãªã¿å…ˆç”Ÿã®å¿ƒã‚’æ´ã‚ã€‚å¤§è°·å…ˆç”ŸãŒãƒ©ã‚¤ãƒãƒ«ã€‚</p>
            </button>
        </div>

        <!-- åå‰å…¥åŠ›ç”»é¢ -->
        <div id="name-input-screen">
            <h2>ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
            <p style="color: #666; margin-bottom: 20px;">
                æ–°ä»»ã®æ•°å­¦æ•™å¸«ã¨ã—ã¦èµ´ä»»ã—ã¦ããŸã‚ãªãŸã€‚<br>
                è·å“¡å®¤ã§å‡ºä¼šã£ãŸå›½èªæ•™å¸«ãƒ»åŒ—äº•ãªã¿å…ˆç”Ÿã«ä¸€ç›®æƒšã‚Œ...ï¼
            </p>
            <input type="text" id="player-name-input" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ" maxlength="10">
            <br>
            <button class="start-button pink" onclick="startGameWithName()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen">
            <div id="game-header" class="game-header">Phase 1: å‹˜é•ã„ã®æ±‚æ„›</div>
            
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
            <div id="status-bar">
                <div class="stat">
                    <div class="stat-label" id="nami-label">ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦</div>
                    <div class="stat-value love" id="nami-affection">0</div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill love" id="nami-bar" style="width: 50%"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">SANå€¤</div>
                    <div class="stat-value" id="san-value">100</div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill san" id="san-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div id="items"></div>
            </div>
            
            <div id="text-window" class="normal">
                <div id="math-effects"></div>
                <div id="character-portrait" class="character-portrait"></div>
                <div id="text-content"></div>
            </div>

            <div id="choices"></div>
            
            <!-- é€ƒèµ°åŠ‡ãƒãƒƒãƒ— -->
            <div id="escape-map">
                <div class="map-info">
                    æ¾æœ¬å…ˆç”Ÿã®ä½ç½®: <span class="map-danger" id="matsumoto-pos">???</span><br>
                    å®‰å…¨åœ°å¸¯ï¼ˆè·å“¡å®¤ï¼‰ã¾ã§é€ƒã’ã‚ï¼
                </div>
                <div id="map-grid"></div>
            </div>
            
            <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="input-section">
                <div id="timer"></div>
                <input type="text" id="excuse-input" placeholder="è«–ç†çš„ãªè¨€ã„è¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                <button class="submit-button" onclick="submitExcuse()">é€ä¿¡</button>
            </div>

            <!-- æ•°å¼ãƒŸãƒ‹ã‚²ãƒ¼ãƒ  -->
            <div id="math-game">
                <h3 id="math-game-title">åŠ è—¤å…ˆç”Ÿã®æ•°å­¦åŠ›ã§è§£æ±ºã›ã‚ˆï¼</h3>
                <div id="math-question"></div>
                <input type="number" id="math-input" placeholder="ç­”ãˆã‚’å…¥åŠ›">
                <button class="submit-button" onclick="submitMathAnswer()">å›ç­”</button>
            </div>
        </div>

        <!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="ending-screen"></div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            mode: 'kato', // 'kato' or 'custom'
            playerName: 'åŠ è—¤',
            currentPhase: 0,
            currentScene: 0,
            namiAffection: 0,
            sanValue: 100,
            items: [],
            playerPos: 4,
            matsumotoPos: 0,
            escapeTurns: 0,
            mathCorrect: 0
        };

        let timerInterval;
        let timeLeft = 15;
        let currentScenarios = [];

        function showModeSelect() {
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('mode-select').style.display = 'block';
        }

        function selectMode(mode) {
            gameState.mode = mode;
            document.getElementById('mode-select').style.display = 'none';
            
            if (mode === 'kato') {
                gameState.playerName = 'åŠ è—¤';
                startGame();
            } else {
                document.getElementById('name-input-screen').style.display = 'block';
            }
        }

        function startGameWithName() {
            const nameInput = document.getElementById('player-name-input').value.trim();
            if (nameInput.length === 0) {
                showNotification('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                return;
            }
            gameState.playerName = nameInput;
            document.getElementById('name-input-screen').style.display = 'none';
            startGame();
        }

        function startGame() {
            document.getElementById('game-screen').style.display = 'block';
            gameState.currentPhase = 1;
            gameState.currentScene = 0;
            gameState.namiAffection = gameState.mode === 'kato' ? 0 : 50;
            gameState.sanValue = 100;
            gameState.items = [];
            
            if (gameState.mode === 'kato') {
                document.getElementById('game-header').textContent = 'Phase 1: å‹˜é•ã„ã®æ±‚æ„›';
                currentScenarios = katoPhase1Scenarios;
            } else {
                document.getElementById('game-header').textContent = 'Phase 1: é‹å‘½ã®å‡ºä¼šã„';
                document.getElementById('game-header').classList.add('romance');
                currentScenarios = customPhase1Scenarios;
            }
            
            updateStatus();
            showScene();
        }

        // åŠ è—¤å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã®ã‚·ãƒŠãƒªã‚ª
        const katoPhase1Scenarios = [
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "è·å“¡å®¤ã€‚æ•°å­¦æ•™å¸«ãƒ»åŠ è—¤å…ˆç”Ÿã¯é’ãƒšãƒ³ã‚’æ¡ã‚Šã—ã‚ã¦ã„ãŸã€‚éš£ã®å¸­ã«åº§ã‚‹å›½èªç§‘ãƒ»åŒ—äº•ãªã¿å…ˆç”Ÿã‚’è¦³å¯Ÿã—ãªãŒã‚‰ã€‚",
                choices: null
            },
            {
                speaker: "åŠ è—¤",
                text: "ï¼ˆæ€è€ƒä¸­ï¼‰åŒ—äº•ãªã¿å…ˆç”Ÿã¨ã®é©åˆç‡ã‚’è¨ˆç®—ã—ãŸçµæœ...92.4%ã€‚æ ¹æ‹ ï¼šâ‘ åŒã˜è·å“¡å®¤ã€â‘¡å¸­ãŒéš£æ¥ã€â‘¢æ¯æ—¥æŒ¨æ‹¶ã‚’äº¤ã‚ã™ã€‚å®Œç’§ãªè«–ç†ã ã€‚",
                choices: null,
                effects: true,
                portrait: "ğŸ§®"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãã‚“ãªæ™‚ã€ãªã¿å…ˆç”ŸãŒæ›¸é¡ã‚’åºŠã«è½ã¨ã—ã¦ã—ã¾ã£ãŸã€‚ãƒãƒ£ãƒ³ã‚¹åˆ°æ¥ï¼",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ã‚...ã™ã¿ã¾ã›ã‚“...",
                choices: [
                    {
                        text: "Aï¼šã€ŒãƒŸã‚¹ã®ç™ºç”Ÿé »åº¦ã‚’ã‚°ãƒ©ãƒ•åŒ–ã—ã¾ã—ã‚‡ã†ã€‚æ”¹å–„ã«å½¹ç«‹ã¡ã¾ã™ã€",
                        result: -5,
                        san: -5
                    },
                    {
                        text: "Bï¼šã€Œå›ã®è„³ã®ãƒ¡ãƒ¢ãƒªãŒä¸è¶³ã—ã¦ã„ã¾ã™ã­ã€‚æœ€é©åŒ–ãŒå¿…è¦ã§ã™ã€",
                        result: -8,
                        san: -10
                    },
                    {
                        text: "Cï¼šç„¡è¨€ã§é’ãƒšãƒ³ã‚’å·®ã—å‡ºã™ï¼ˆç²¾ä¸€æ¯ã®å„ªã—ã•ï¼‰",
                        result: -3,
                        san: -3
                    }
                ],
                portrait: "ğŸ°",
                isNami: true
            },
            {
                speaker: "ãªã¿",
                text: "ãƒ’ãƒƒ...ï¼",
                innerThought: "ï¼ˆåŠ è—¤å…ˆç”Ÿã®çœ¼åŠ›ãŒæ€–ã™ãã‚‹...æ€’ã£ã¦ã‚‹...ï¼Ÿï¼‰",
                choices: null,
                portrait: "ğŸ˜¨",
                isNami: true
            },
            {
                speaker: "å¤§è°·",
                text: "ãŠã£ã¨ã€ãªã¿å…ˆç”Ÿå¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿï¼ˆçˆ½ã‚„ã‹ã«æ›¸é¡ã‚’æ‹¾ã†ï¼‰ã¯ã„ã€ã©ã†ãï¼",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™å¤§è°·å…ˆç”Ÿ...ï¼",
                innerThought: "ï¼ˆå¤§è°·å…ˆç”Ÿã¯å„ªã—ãã¦...å®‰å¿ƒã™ã‚‹...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Œ",
                isNami: true
            },
            {
                speaker: "åŠ è—¤",
                text: "ï¼ˆæ€è€ƒä¸­ï¼‰...ãŠã‹ã—ã„ã€‚åƒ•ã®æ–¹ãŒè«–ç†çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ã—ãŸã¯ãšã ã€‚ãªãœå¤§è°·ã®æ–¹ãŒå¥½æ„Ÿåº¦ãŒä¸ŠãŒã‚‹ã®ã ï¼Ÿ",
                choices: null,
                effects: true,
                portrait: "ğŸ¤”"
            },
            {
                speaker: "ç•‘",
                text: "ï¼ˆéš£ã®å¸­ã‹ã‚‰ï¼‰ã‚ã‚‰ã‚ã‚‰ã€åŠ è—¤å…ˆç”Ÿã€‚äººã®å¿ƒã¯æ•°å¼ã§ã¯è¡¨ã›ãªã„ã®ã‚ˆï¼Ÿé£´ã¡ã‚ƒã‚“ã§ã‚‚é£Ÿã¹ã¦è½ã¡ç€ããªã•ã„ã€‚",
                choices: null,
                item: "é»’ç³–é£´",
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "ç•‘å…ˆç”Ÿ...ï¼ˆé’ãƒšãƒ³ã‚’ã‚«ãƒã‚«ãƒé³´ã‚‰ã™ï¼‰ã—ã‹ã—ã€è«–ç†çš„ã«è€ƒãˆã‚Œã°...",
                choices: null,
                portrait: "ğŸ§®"
            },
            {
                speaker: "ç•‘",
                text: "ï¼ˆã‚¯ã‚¹ã‚¯ã‚¹ç¬‘ã„ãªãŒã‚‰ï¼‰ãã†ã„ã†ã¨ã“ã‚ã‚ˆã€åŠ è—¤å…ˆç”Ÿã€‚ã§ã‚‚ã€ãã‚ŒãŒåŠ è—¤å…ˆç”Ÿã‚‰ã—ãã¦...å¥½ãã‚ˆï¼Ÿ",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "åŠ è—¤",
                text: "...ï¼Ÿ",
                innerThought: "ï¼ˆç•‘å…ˆç”Ÿã®è¨€è‘‰ã®æ„å‘³ãŒç†è§£ã§ããªã„...å¥½ã...ï¼Ÿãƒ‡ãƒ¼ã‚¿ä¸è¶³ã ï¼‰",
                choices: null,
                effects: true,
                portrait: "â“"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ•°æ—¥å¾Œã€æ˜¼ä¼‘ã¿ã€‚åŠ è—¤å…ˆç”Ÿã¯æ•°å­¦æº–å‚™å®¤ã§ä¸€äººãƒ†ã‚¹ãƒˆã®æ¡ç‚¹ã‚’ã—ã¦ã„ãŸã€‚",
                choices: null
            },
            {
                speaker: "åŠ è—¤",
                text: "ï¼ˆæ€è€ƒä¸­ï¼‰åŒ—äº•å…ˆç”Ÿã¸ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹ã™ã‚‹ã€‚ä»Šåº¦ã¯æ•°å­¦ã®é¢ç™½ã•ã‚’ä¼ãˆã€å…±é€šã®è©±é¡Œã‚’ä½œã‚‹ä½œæˆ¦ã ã€‚",
                choices: null,
                effects: true,
                portrait: "ğŸ§®"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "å»Šä¸‹ã§ãªã¿å…ˆç”Ÿã‚’è¦‹ã¤ã‘ãŸåŠ è—¤å…ˆç”Ÿã¯å£°ã‚’ã‹ã‘ã‚‹ã€‚",
                choices: null
            },
            {
                speaker: "åŠ è—¤",
                text: "åŒ—äº•å…ˆç”Ÿã€å°‘ã—ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
                choices: null,
                portrait: "ğŸ§®"
            },
            {
                speaker: "ãªã¿",
                text: "ã¯ã€ã¯ã„...ï¼",
                innerThought: "ï¼ˆã¾ãŸæ€’ã‚‰ã‚Œã‚‹ã®ã‹ãª...ãƒ‰ã‚­ãƒ‰ã‚­...ï¼‰",
                choices: null,
                portrait: "ğŸ˜°",
                isNami: true
            },
            {
                speaker: "åŠ è—¤",
                text: "ã‚ãªãŸã«ã€æ•°å­¦ã®ç¾ã—ã•ã«ã¤ã„ã¦ãŠè©±ã—ã—ãŸã„ã®ã§ã™ã€‚",
                choices: [
                    {
                        text: "Aï¼šã€Œãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—ã®ç¾ã—ã•ã«ã¤ã„ã¦1æ™‚é–“ã»ã©èªã‚‰ã›ã¦ãã ã•ã„ã€",
                        result: -7,
                        san: -8
                    },
                    {
                        text: "Bï¼šã€Œå›ã®æˆæ¥­ã®éåŠ¹ç‡æ€§ã‚’æ”¹å–„ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã—ãŸã€",
                        result: -10,
                        san: -12
                    },
                    {
                        text: "Cï¼šã€Œã‚ã®...ãŠã€ãŠèŒ¶ã§ã‚‚...ã€ï¼ˆé¡”ã‚’çœŸã£èµ¤ã«ã™ã‚‹ï¼‰",
                        result: -2,
                        san: -5
                    }
                ],
                portrait: "ğŸ§®"
            },
            {
                speaker: "ãªã¿",
                text: "ã”ã€ã”ã‚ã‚“ãªã•ã„ï¼ç§ã€æ•°å­¦è‹¦æ‰‹ã§...ï¼ãã‚Œã«æ€’ã‚‰ã‚Œã‚‹ã®æ€–ã„ã‚“ã§ã™...ï¼",
                innerThought: "ï¼ˆåŠ è—¤å…ˆç”Ÿã®ç›®ãŒ...é‹­ã™ãã¦...æ³£ããã†...ï¼‰",
                choices: null,
                portrait: "ğŸ˜¢",
                isNami: true
            },
            {
                speaker: "å¤§è°·",
                text: "ãŠã‚„ãŠã‚„ã€œã€ã¾ãŸãªã¿å…ˆç”Ÿã‚’å›°ã‚‰ã›ã¦ã¾ã™ã­ã€åŠ è—¤ã‚»ãƒ³ãƒ‘ã‚¤ã€‚ãã®çœ¼åŠ›ã€ç”Ÿå¾’ã‚‚æ€–ãŒã£ã¦ã¾ã™ã‚ˆï¼Ÿ",
                choices: null,
                portrait: "ğŸ˜…"
            },
            {
                speaker: "åŠ è—¤",
                text: "...ç§ã¯æ€’ã£ã¦ã„ãªã„ã€‚ãŸã åŠ¹ç‡çš„ãªææ¡ˆã‚’...",
                choices: null,
                portrait: "ğŸ˜"
            },
            {
                speaker: "å¤§è°·",
                text: "ãã†ã„ã†ã¨ã“ã§ã™ã‚ˆã€œã€‚ãªã¿å…ˆç”Ÿã€ä¿ºã¨ä¸€ç·’ã«æº–å‚™å®¤è¡Œãã¾ã—ã‚‡ã†ã€‚ãŠèŒ¶æ·¹ã‚Œã¾ã™ã‹ã‚‰ï¼",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãªã¿",
                text: "ã¯ã€ã¯ã„...ï¼",
                innerThought: "ï¼ˆå¤§è°·å…ˆç”Ÿã«åŠ©ã‘ã‚‰ã‚ŒãŸ...ã‚ã‚ŠãŒãŸã„...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Œ",
                isNami: true
            },
            {
                speaker: "åŠ è—¤",
                text: "...ã€‚",
                innerThought: "ï¼ˆé’ãƒšãƒ³ã‚’å¼·ãæ¡ã‚Šã—ã‚ã‚‹ã€‚ä½•ãŒé–“é•ã£ã¦ã„ã‚‹ã®ã‹...ï¼‰",
                choices: null,
                effects: true,
                portrait: "ğŸ˜"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ”¾èª²å¾Œã€è·å“¡å®¤ã€‚åŠ è—¤å…ˆç”Ÿã¯è‡ªå¸­ã§è«–ç†çš„æ€è€ƒã«ãµã‘ã£ã¦ã„ãŸã€‚",
                choices: null
            },
            {
                speaker: "åŠ è—¤",
                text: "ï¼ˆæ€è€ƒä¸­ï¼‰å¤‰æ•°ã‚’è¦‹ç›´ã™å¿…è¦ãŒã‚ã‚‹ã€‚åƒ•ã®ä½•ãŒé–“é•ã£ã¦ã„ã‚‹ã®ã‹...æ–¹ç¨‹å¼ã‚’è§£ãç›´ã•ã­ã°ã€‚",
                choices: null,
                effects: true,
                mathGame: true,
                portrait: "ğŸ§®"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ•°æ—¥å¾Œã€æ”¾èª²å¾Œã®æ¸¡ã‚Šå»Šä¸‹ã€‚åŠ è—¤å…ˆç”Ÿã¯æ±ºæ„ã‚’å›ºã‚ãŸã€‚",
                choices: null
            },
            {
                speaker: "åŠ è—¤",
                text: "åŒ—äº•å…ˆç”Ÿã€ã‚ãªãŸã«ä¼ãˆãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚",
                choices: null,
                portrait: "ğŸ§®"
            },
            {
                speaker: "ãªã¿",
                text: "ã¯ã€ã¯ã„...",
                innerThought: "ï¼ˆã¾ãŸæ€’ã‚‰ã‚Œã‚‹ã®ã‹ãª...ï¼‰",
                choices: null,
                portrait: "ğŸ˜°",
                isNami: true
            },
            {
                speaker: "åŠ è—¤",
                text: "åƒ•ã¯...åƒ•ã¯ã‚ãªãŸã®ã“ã¨ã‚’...è«–ç†çš„ã«åˆ†æã—ãŸçµæœã€åƒ•ã®æ„Ÿæƒ…é–¢æ•°ã«ãŠã„ã¦æœ€å¤§å€¤ã‚’ç¤ºã™ã®ãŒã‚ãªãŸã§ã‚ã‚‹ã¨çµè«–ã¥ã‘ã¾ã—ãŸã€‚",
                choices: null,
                effects: true,
                portrait: "ğŸ§®"
            },
            {
                speaker: "ãªã¿",
                text: "ãˆ...ï¼Ÿ",
                innerThought: "ï¼ˆä½•ã‚’è¨€ã£ã¦ã‚‹ã®ã‹å…¨ç„¶ã‚ã‹ã‚‰ãªã„...ï¼‰",
                choices: null,
                portrait: "ğŸ˜µ",
                isNami: true
            },
            {
                speaker: "åŠ è—¤",
                text: "ã¤ã¾ã‚Š...å¥½ãã§ã™ã€‚äº¤éš›ã‚’ç”³ã—è¾¼ã¿ã¾ã™ã€‚",
                choices: null,
                portrait: "ğŸ˜³"
            },
            {
                speaker: "ãªã¿",
                text: "...ã™ã€ã™ã¿ã¾ã›ã‚“åŠ è—¤å…ˆç”Ÿ...ï¼ç§ã€å¤§è°·å…ˆç”Ÿã®ã“ã¨ãŒ...å¥½ããªã‚“ã§ã™...",
                innerThought: "ï¼ˆã”ã‚ã‚“ãªã•ã„...ã§ã‚‚åŠ è—¤å…ˆç”Ÿã¯æ€–ãã¦...ï¼‰",
                choices: null,
                portrait: "ğŸ˜¢",
                isNami: true
            },
            {
                speaker: "åŠ è—¤",
                text: "...ãã†ã€ã§ã™ã‹ã€‚",
                innerThought: "ï¼ˆé’ãƒšãƒ³ã®ãƒãƒƒã‚¯éƒ¨åˆ†ã‚’ã‚«ãƒã‚«ãƒé³´ã‚‰ã—ç¶šã‘ã‚‹ï¼‰",
                choices: null,
                portrait: "ğŸ˜”"
            },
            {
                speaker: "ãªã¿",
                text: "æœ¬å½“ã«...ã”ã‚ã‚“ãªã•ã„...ï¼",
                innerThought: "ï¼ˆèµ°ã‚Šå»ã‚‹ï¼‰",
                choices: null,
                portrait: "ğŸƒâ€â™€ï¸",
                isNami: true
            },
            {
                speaker: "åŠ è—¤",
                text: "...åƒ•ã®è¨ˆç®—å¼ã®ã©ã“ãŒé–“é•ã£ã¦ã„ãŸã‚“ã ...",
                innerThought: "ï¼ˆå¤•æ—¥ã‚’èƒŒã«ç«‹ã¡å°½ãã™ï¼‰",
                choices: null,
                effects: true,
                san: -20,
                portrait: "ğŸ˜"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "Phase 1 çµ‚äº†ã€‚åŠ è—¤å…ˆç”Ÿã®å¿ƒã¯æ·±ãå‚·ã¤ãã€SANå€¤ãŒå¤§å¹…ã«ä½ä¸‹ã—ãŸã€‚ãã—ã¦ç¿Œæ—¥ã€å½¼ã‚’ç‹™ã†å½±ãŒå¿ã³å¯„ã‚‹...",
                choices: null
            }
        ];

        // æ‹æ„›ãƒ¢ãƒ¼ãƒ‰ã®ã‚·ãƒŠãƒªã‚ªï¼ˆãªã¿å…ˆç”Ÿæ”»ç•¥å¯èƒ½ï¼‰
        const customPhase1Scenarios = [
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: `æ–°å¹´åº¦ã€4æœˆã€‚${gameState.playerName || 'ã‚ãªãŸ'}ã¯æ–°ä»»ã®æ•°å­¦æ•™å¸«ã¨ã—ã¦ã€ã“ã®å­¦æ ¡ã«èµ´ä»»ã—ã¦ããŸã€‚`,
                choices: null
            },
            {
                speaker: "æ ¡é•·",
                text: "ã§ã¯ã€æ–°ã—ãæ¥ã¦ãã‚ŒãŸæ•°å­¦ç§‘ã®å…ˆç”Ÿã‚’ç´¹ä»‹ã—ã¾ã™ã€‚",
                choices: null,
                portrait: "ğŸ‘´"
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: `${gameState.playerName}ã§ã™ã€‚æ•°å­¦ã‚’æ‹…å½“ã—ã¾ã™ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚`,
                choices: null,
                portrait: "ğŸ‘¤"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "è·å“¡å®¤ã§è‡ªå·±ç´¹ä»‹ã‚’çµ‚ãˆãŸã‚ãªãŸã€‚å¸­ã«æ¡ˆå†…ã•ã‚Œã‚‹ã€‚",
                choices: null
            },
            {
                speaker: "ç•‘",
                text: `ã‚ã‚‰ã‚ã‚‰ã€${gameState.playerName}å…ˆç”Ÿã­ã€‚ç§ã¯ç•‘ã¨è¨€ã„ã¾ã™ã€‚æ•°å­¦ç§‘ã®å…ˆè¼©ã‚ˆã€‚ã‚ˆã‚ã—ãã­ã€‚`,
                choices: null,
                item: "é»’ç³–é£´",
                portrait: "ğŸ‘µ"
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ç•‘å…ˆç”Ÿã€‚",
                choices: null,
                portrait: "ğŸ‘¤"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãã®æ™‚ã€è·å“¡å®¤ã®å…¥å£ã‹ã‚‰ä¸€äººã®å¥³æ€§æ•™å¸«ãŒå…¥ã£ã¦ããŸã€‚ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ã€å°å‹•ç‰©ã®ã‚ˆã†ãªå¯æ„›ã‚‰ã—ã„é›°å›²æ°—ã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã€ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™...ï¼",
                innerThought: "ï¼ˆæ–°ã—ã„å…ˆç”Ÿã ...ç·Šå¼µã™ã‚‹ãª...ï¼‰",
                choices: null,
                portrait: "ğŸ°",
                isNami: true,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ã‚ãªãŸã¯æ€ã‚ãšè¦‹ã¨ã‚Œã¦ã—ã¾ã£ãŸã€‚å¯æ„›ã„...ï¼",
                choices: null
            },
            {
                speaker: "ç•‘",
                text: "ã‚ã‚‰ã€ãªã¿ã¡ã‚ƒã‚“ã€‚ã¡ã‚‡ã†ã©è‰¯ã‹ã£ãŸã‚ã€‚éš£ã®å¸­ã«ãªã‚‹æ–°ä»»ã®å…ˆç”Ÿã‚ˆã€‚",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã€ã¯ã˜ã‚ã¾ã—ã¦...ï¼åŒ—äº•ãªã¿ã¨è¨€ã„ã¾ã™ã€‚å›½èªã‚’æ‹…å½“ã—ã¦ã„ã¾ã™ã€‚",
                innerThought: "ï¼ˆå„ªã—ãã†ãªäººã ã¨ã„ã„ãª...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: `${gameState.playerName}ã§ã™ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚`,
                choices: [
                    {
                        text: "Aï¼šã€Œå›½èªã§ã™ã‹ã€‚æ•°å­¦ã¨ã¯å¯¾ç…§çš„ã§ã™ã­ã€ï¼ˆç¬‘é¡”ã§ï¼‰",
                        result: 5,
                        isGood: true
                    },
                    {
                        text: "Bï¼šã€Œå›½èªã¯è«–ç†çš„æ€è€ƒåŠ›ãŒä¸è¶³ã—ãŒã¡ã§ã™ãŒã€å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿã€",
                        result: -5,
                        isGood: false
                    },
                    {
                        text: "Cï¼šã€Œã‚ã€ã‚ã®...ã‚ˆã‚ã—ã...ã€ï¼ˆç·Šå¼µã—ã¦ç›®ã‚’é€¸ã‚‰ã™ï¼‰",
                        result: 2,
                        isGood: true
                    }
                ],
                portrait: "ğŸ‘¤"
            },
            {
                speaker: "ãªã¿",
                text: "ã¯ã„ã€ã“ã¡ã‚‰ã“ãï¼",
                innerThought: "ï¼ˆè‰¯ã‹ã£ãŸ...å„ªã—ãã†ãªäººã ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true,
                affectionCheck: true
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãã®æ™‚ã€çˆ½ã‚„ã‹ãªç¬‘é¡”ã®ç”·æ€§æ•™å¸«ãŒå…¥ã£ã¦ããŸã€‚",
                choices: null
            },
            {
                speaker: "å¤§è°·",
                text: "ãŠã£ã™ï¼ãªã¿å…ˆç”Ÿã€ãŠã¯ã‚ˆã†ã€œï¼",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã€å¤§è°·å…ˆç”Ÿï¼ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼",
                innerThought: "ï¼ˆå¤§è°·å…ˆç”Ÿã€ä»Šæ—¥ã‚‚å…ƒæ°—ã ãª...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: "å¤§è°·",
                text: `ãŠã€æ–°ã—ã„å…ˆç”Ÿï¼Ÿä¿ºã¯å¤§è°·ã€‚å›½èªç§‘ã§ãƒãƒ¬ãƒ¼éƒ¨ã®é¡§å•ã‚„ã£ã¦ã¾ã™ã€‚${gameState.playerName}å…ˆç”Ÿã€ã‚ˆã‚ã—ãï¼`,
                choices: null,
                portrait: "ğŸ˜„"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "å¤§è°·å…ˆç”Ÿã¯é«˜èº«é•·ã‚¤ã‚±ãƒ¡ãƒ³ã§ã€ãªã¿å…ˆç”Ÿã¨ã‚‚è¦ªã—ãã†ã ã€‚ãƒ©ã‚¤ãƒãƒ«...ï¼Ÿ",
                choices: null
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ•°æ—¥å¾Œã€æ˜¼ä¼‘ã¿ã€‚è·å“¡å®¤ã§å¼å½“ã‚’é£Ÿã¹ã¦ã„ã‚‹ã¨ã€ãªã¿å…ˆç”ŸãŒå›°ã£ãŸé¡”ã‚’ã—ã¦ã„ãŸã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ã†ã€œã‚“...ã“ã®è³‡æ–™ã€ã©ã†ã¾ã¨ã‚ã‚ˆã†...",
                innerThought: "ï¼ˆè‹¦æ‰‹ãªã‚“ã ã‚ˆãª...ã“ã†ã„ã†ã®...ï¼‰",
                choices: null,
                portrait: "ğŸ˜¥",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "åŒ—äº•å…ˆç”Ÿã€ä½•ã‹å›°ã£ã¦ã¾ã™ï¼Ÿ",
                choices: [
                    {
                        text: "Aï¼šã€Œæ‰‹ä¼ã„ã¾ã—ã‚‡ã†ã‹ï¼Ÿã€ï¼ˆå„ªã—ãå£°ã‚’ã‹ã‘ã‚‹ï¼‰",
                        result: 8,
                        isGood: true
                    },
                    {
                        text: "Bï¼šã€ŒåŠ¹ç‡çš„ã«ã‚„ã‚Œã°ç°¡å˜ã§ã™ã‚ˆã€‚è¦‹ã¦ã¦ä¸‹ã•ã„ã€ï¼ˆå‹æ‰‹ã«è³‡æ–™ã‚’å–ã‚‹ï¼‰",
                        result: -3,
                        isGood: false
                    },
                    {
                        text: "Cï¼šã€Œå¤§ä¸ˆå¤«ã§ã™ã‹...ï¼Ÿã€ï¼ˆå¿ƒé…ãã†ã«è¦‹ã‚‹ï¼‰",
                        result: 5,
                        isGood: true
                    }
                ],
                portrait: "ğŸ‘¤"
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™...ï¼åŠ©ã‹ã‚Šã¾ã™...ï¼",
                innerThought: "ï¼ˆå„ªã—ã„...å¬‰ã—ã„...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true,
                affectionCheck: true
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ã‚ãªãŸã¯ãªã¿å…ˆç”Ÿã®éš£ã«åº§ã‚Šã€ä¸€ç·’ã«è³‡æ–™ã‚’æ•´ç†ã—ãŸã€‚æ™‚ã€…ãªã¿å…ˆç”Ÿã®ç¬‘é¡”ãŒè¦‹ãˆã¦ã€å¿ƒãŒæ¸©ã‹ããªã‚‹ã€‚",
                choices: null,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: "ãªã¿",
                text: `${gameState.playerName}å…ˆç”Ÿã€æœ¬å½“ã«åŠ©ã‹ã‚Šã¾ã—ãŸ...ï¼ãŠç¤¼ã«ã€ãŠèŒ¶ã§ã‚‚ã©ã†ã§ã™ã‹ï¼Ÿ`,
                innerThought: "ï¼ˆãŠè©±ã—ã—ãŸã„ãª...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ã„ã„ã‚“ã§ã™ã‹ï¼Ÿãœã²ï¼",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ”¾èª²å¾Œã€æº–å‚™å®¤ã§ãŠèŒ¶ã‚’é£²ã¿ãªãŒã‚‰ã€ãªã¿å…ˆç”Ÿã¨è©±ã™ã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: "ç§ã€å®Ÿã¯å°å‹•ç‰©ãŒå¥½ããªã‚“ã§ã™...ã‚¦ã‚µã‚®ã¨ã‹ã€ãƒãƒ ã‚¹ã‚¿ãƒ¼ã¨ã‹...â™ª",
                innerThought: "ï¼ˆã‚‚ãµã‚‚ãµã—ãŸã„...ï¼‰",
                choices: null,
                portrait: "ğŸ°",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ã¸ã‡ã€å¯æ„›ã„ã§ã™ã­ã€‚",
                choices: [
                    {
                        text: "Aï¼šã€ŒåŒ—äº•å…ˆç”Ÿã‚‚å°å‹•ç‰©ã¿ãŸã„ã§å¯æ„›ã„ã§ã™ã‚ˆã€ï¼ˆç¬‘é¡”ã§ï¼‰",
                        result: 12,
                        isGood: true
                    },
                    {
                        text: "Bï¼šã€Œå‹•ç‰©ã¯éåŠ¹ç‡çš„ãªå­˜åœ¨ã§ã™ãŒã€ç™’ã‚„ã—åŠ¹æœã¯èªã‚ã¾ã™ã€",
                        result: -5,
                        isGood: false
                    },
                    {
                        text: "Cï¼šã€Œä¿ºã‚‚å‹•ç‰©å¥½ãã§ã™ã€‚ã„ã¤ã‹ä¸€ç·’ã«å‹•ç‰©åœ’è¡ŒããŸã„ã§ã™ã­ã€",
                        result: 10,
                        isGood: true
                    }
                ],
                portrait: "ğŸ‘¤"
            },
            {
                speaker: "ãªã¿",
                text: "ãˆã¸ã¸...ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™...â™¡",
                innerThought: "ï¼ˆè¤’ã‚ã‚‰ã‚Œã¡ã‚ƒã£ãŸ...å¬‰ã—ã„...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true,
                affectionCheck: true,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãã®æ™‚ã€å¤§è°·å…ˆç”ŸãŒå…¥ã£ã¦ããŸã€‚",
                choices: null
            },
            {
                speaker: "å¤§è°·",
                text: "ãŠã€ãªã¿å…ˆç”Ÿï¼ã‚ã‚Œã€æ–°äººã®å…ˆç”Ÿã‚‚ä¸€ç·’ï¼Ÿ",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãªã¿",
                text: `${gameState.playerName}å…ˆç”ŸãŒè³‡æ–™æ‰‹ä¼ã£ã¦ãã‚ŒãŸã‚“ã§ã™ã€‚`,
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: "å¤§è°·",
                text: "ã¸ã‡ã€œã€è‰¯ã„äººã˜ã‚ƒã‚“ï¼ä¿ºã‚‚ãªã¿å…ˆç”Ÿã¨ã‚ˆããŠèŒ¶ã™ã‚‹ã‚“ã ã‚ˆã­ã€œ",
                choices: null,
                portrait: "ğŸ˜„"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "å¤§è°·å…ˆç”Ÿã®å­˜åœ¨æ„ŸãŒå¼·ã„...ã“ã‚Œã¯ãƒ©ã‚¤ãƒãƒ«ã ã€‚",
                choices: null
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "æ•°æ—¥å¾Œã€å»Šä¸‹ã§ãªã¿å…ˆç”ŸãŒç”Ÿå¾’ã«å›²ã¾ã‚Œã¦ã„ãŸã€‚",
                choices: null
            },
            {
                speaker: "ç”Ÿå¾’A",
                text: "å…ˆç”Ÿã€œï¼ã“ã®å•é¡Œæ•™ãˆã¦ä¸‹ã•ã„ï¼",
                choices: null,
                portrait: "ğŸ‘¦"
            },
            {
                speaker: "ãªã¿",
                text: "ãˆãˆã£ã¨...ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­...ï¼",
                innerThought: "ï¼ˆãŸãã•ã‚“æ¥ã¡ã‚ƒã£ãŸ...ã©ã†ã—ã‚ˆã†...ï¼‰",
                choices: null,
                portrait: "ğŸ˜°",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "åŒ—äº•å…ˆç”Ÿã€æ‰‹ä¼ã„ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
                choices: [
                    {
                        text: "Aï¼šã€Œä¿ºã‚‚ä¸€ç·’ã«æ•™ãˆã¾ã™ã‚ˆã€ï¼ˆç¬‘é¡”ã§ï¼‰",
                        result: 10,
                        isGood: true
                    },
                    {
                        text: "Bï¼šã€ŒåŠ¹ç‡çš„ã«å‡¦ç†ã—ã¾ã—ã‚‡ã†ã€‚åˆ—ã«ä¸¦ã°ã›ã¦ãã ã•ã„ã€",
                        result: 0,
                        isGood: false
                    },
                    {
                        text: "Cï¼šã€Œå¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿç„¡ç†ã—ãªã„ã§ãã ã•ã„ã­ã€",
                        result: 7,
                        isGood: true
                    }
                ],
                portrait: "ğŸ‘¤"
            },
            {
                speaker: "ãªã¿",
                text: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™...ï¼åŠ©ã‹ã‚Šã¾ã™...ï¼",
                innerThought: "ï¼ˆã¾ãŸåŠ©ã‘ã¦ãã‚ŒãŸ...å„ªã—ã„...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true,
                affectionCheck: true
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ç”Ÿå¾’ãŸã¡ã«æ•™ãˆçµ‚ã‚ã£ãŸå¾Œã€äºŒäººã§æ­©ãã€‚",
                choices: null
            },
            {
                speaker: "ãªã¿",
                text: `${gameState.playerName}å…ˆç”Ÿã£ã¦...æœ¬å½“ã«å„ªã—ã„ã‚“ã§ã™ã­...`,
                innerThought: "ï¼ˆãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ãã‚“ãª...å½“ãŸã‚Šå‰ã®ã“ã¨ã§ã™ã‚ˆã€‚",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãã—ã¦ã€æ”¾èª²å¾Œã®æ¸¡ã‚Šå»Šä¸‹ã€‚å¤•æ—¥ãŒå·®ã—è¾¼ã‚€ä¸­ã€ã‚ãªãŸã¯æ±ºæ„ã—ãŸã€‚",
                choices: null,
                effects: true,
                effectType: 'heart'
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "åŒ—äº•å…ˆç”Ÿã€å°‘ã—ã„ã„ã§ã™ã‹ï¼Ÿ",
                choices: null,
                portrait: "ğŸ‘¤"
            },
            {
                speaker: "ãªã¿",
                text: "ã¯ã„...ã©ã†ã—ã¾ã—ãŸï¼Ÿ",
                innerThought: "ï¼ˆãƒ‰ã‚­ãƒ‰ã‚­...ä½•ã ã‚ã†...ï¼‰",
                choices: null,
                portrait: "ğŸ˜Š",
                isNami: true
            },
            {
                speaker: gameState.playerName || 'ã‚ãªãŸ',
                text: "ä¿º...åŒ—äº•å…ˆç”Ÿã®ã“ã¨ãŒ...",
                choices: null,
                portrait: "ğŸ˜³"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ã“ã®ç¬é–“ã€ãªã¿å…ˆç”Ÿã¸ã®å¥½æ„Ÿåº¦ãŒå‹æ•—ã‚’åˆ†ã‘ã‚‹...ï¼",
                choices: null,
                finalCheck: true
            }
        ];

        function updateStatus() {
            document.getElementById('nami-affection').textContent = gameState.namiAffection;
            document.getElementById('san-value').textContent = gameState.sanValue;
            
            const namiBar = document.getElementById('nami-bar');
            const sanBar = document.getElementById('san-bar');
            
            const namiPercent = gameState.mode === 'kato' 
                ? Math.max(0, Math.min(100, 50 + gameState.namiAffection))
                : Math.max(0, Math.min(100, gameState.namiAffection));
            
            namiBar.style.width = namiPercent + '%';
            sanBar.style.width = gameState.sanValue + '%';
            
            if (gameState.sanValue < 30) {
                document.getElementById('san-value').classList.add('danger');
            }
            
            // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º
            const itemsDiv = document.getElementById('items');
            itemsDiv.innerHTML = '';
            gameState.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.textContent = item;
                itemsDiv.appendChild(itemDiv);
            });
        }

        function showScene() {
            const textWindow = document.getElementById('text-window');
            const textContent = document.getElementById('text-content');
            const choicesDiv = document.getElementById('choices');
            const mathEffects = document.getElementById('math-effects');
            const portraitDiv = document.getElementById('character-portrait');
            const escapeMap = document.getElementById('escape-map');
            const mathGame = document.getElementById('math-game');
            const inputSection = document.getElementById('input-section');

            choicesDiv.innerHTML = '';
            choicesDiv.style.display = 'none';
            escapeMap.style.display = 'none';
            mathGame.style.display = 'none';
            inputSection.style.display = 'none';
            mathEffects.innerHTML = '';
            portraitDiv.textContent = '';

            let scene = currentScenarios[gameState.currentScene];

            if (!scene) {
                if (gameState.currentPhase === 1 && gameState.mode === 'kato') {
                    startPhase2();
                } else if (gameState.currentPhase === 1 && gameState.mode === 'custom') {
                    checkNamiEnding();
                } else if (gameState.currentPhase === 2) {
                    startPhase3();
                }
                return;
            }

            // æœ€çµ‚ãƒã‚§ãƒƒã‚¯
            if (scene.finalCheck) {
                checkNamiEnding();
                return;
            }

            // å¥½æ„Ÿåº¦ãƒã‚§ãƒƒã‚¯
            if (scene.affectionCheck && gameState.mode === 'custom') {
                const lastChoice = currentScenarios[gameState.currentScene - 1];
                if (lastChoice && lastChoice.choices) {
                    const choiceResult = document.createElement('div');
                    choiceResult.className = 'inner-thought';
                    if (gameState.namiAffection > 60) {
                        choiceResult.innerHTML = 'ğŸ’– ãªã¿å…ˆç”Ÿã®å¥½æ„Ÿåº¦ãŒä¸ŠãŒã£ãŸï¼';
                        choiceResult.style.color = '#ec407a';
                    }
                    setTimeout(() => {
                        textContent.appendChild(choiceResult);
                    }, 500);
                }
            }

            // Phase 2ã®æ¼”å‡º
            if (gameState.currentPhase === 2) {
                textWindow.classList.remove('normal', 'romance');
                textWindow.classList.add('horror');
                document.getElementById('game-header').classList.add('horror');
                document.getElementById('game-header').textContent = 'Phase 2: ææ€–ã®é€ƒèµ°åŠ‡';
            }

            // ç«‹ã¡çµµè¡¨ç¤º
            if (scene.portrait) {
                portraitDiv.textContent = scene.portrait;
            }

            // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            if (scene.effects) {
                const effectType = scene.effectType || 'math';
                if (effectType === 'heart') {
                    textWindow.classList.remove('normal');
                    textWindow.classList.add('romance');
                    const symbols = ['ğŸ’•', 'ğŸ’–', 'ğŸ’—', 'ğŸ’˜', 'ğŸ’', 'â¤ï¸', 'ğŸ’“'];
                    for (let i = 0; i < 8; i++) {
                        const symbol = document.createElement('div');
                        symbol.className = 'heart-symbol';
                        symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                        symbol.style.left = Math.random() * 80 + '%';
                        symbol.style.top = Math.random() * 80 + '%';
                        symbol.style.animationDelay = Math.random() * 2 + 's';
                        mathEffects.appendChild(symbol);
                    }
                } else {
                    const symbols = ['âˆ«', 'âˆ‘', 'âˆš', 'Ï€', 'Î¸', 'âˆ', 'âˆ‚', 'â‰ˆ', 'â‰ ', 'â‰¡', 'Î”', 'Î£', 'Î±', 'Î²', 'Î³'];
                    for (let i = 0; i < 8; i++) {
                        const symbol = document.createElement('div');
                        symbol.className = 'math-symbol';
                        symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                        symbol.style.left = Math.random() * 80 + '%';
                        symbol.style.top = Math.random() * 80 + '%';
                        symbol.style.animationDelay = Math.random() * 2 + 's';
                        mathEffects.appendChild(symbol);
                    }
                }
            }

            // ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
            const speakerClass = scene.isNami ? 'nami' : (gameState.currentPhase === 2 ? 'horror' : '');
            let html = `<span class="character-name ${speakerClass}">${scene.speaker}</span>${scene.text}`;
            
            if (scene.innerThought) {
                html += `<div class="inner-thought">${scene.innerThought}</div>`;
            }
            
            textContent.innerHTML = html;

            // ã‚¢ã‚¤ãƒ†ãƒ å…¥æ‰‹
            if (scene.item) {
                gameState.items.push(scene.item);
                updateStatus();
                showNotification(`ã€Œ${scene.item}ã€ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`);
            }

            // SANå€¤å¤‰æ›´
            if (scene.san) {
                gameState.sanValue = Math.max(0, Math.min(100, gameState.sanValue + scene.san));
                updateStatus();
            }

            // æ•°å¼ãƒŸãƒ‹ã‚²ãƒ¼ãƒ 
            if (scene.mathGame) {
                setTimeout(() => {
                    mathGame.style.display = 'block';
                    if (gameState.mode === 'custom') {
                        document.getElementById('math-game-title').textContent = 'ã‚ãªãŸã®æ•°å­¦åŠ›ã‚’è¦‹ã›ã‚ˆã†ï¼';
                    }
                    startMathGame();
                }, 500);
                return;
            }

            // é€ƒèµ°ã‚²ãƒ¼ãƒ 
            if (scene.escapeGame) {
                setTimeout(() => {
                    escapeMap.style.display = 'block';
                    initEscapeGame();
                }, 500);
                return;
            }

            // é¸æŠè‚¢è¡¨ç¤º
            if (scene.choices) {
                setTimeout(() => {
                    choicesDiv.style.display = 'block';
                    scene.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        const buttonClass = gameState.mode === 'custom' ? 'romance' : 
                            (gameState.currentPhase === 2 ? 'horror' : '');
                        button.className = 'choice-button ' + buttonClass;
                        button.textContent = choice.text;
                        
                        button.onclick = () => makeChoice(index, choice);
                        
                        choicesDiv.appendChild(button);
                    });
                }, 500);
            } else {
                // æ¬¡ã¸ãƒœã‚¿ãƒ³
                setTimeout(() => {
                    choicesDiv.style.display = 'block';
                    const button = document.createElement('button');
                    button.className = 'continue-button' + (gameState.mode === 'custom' ? ' romance' : '');
                    button.textContent = 'æ¬¡ã¸';
                    button.onclick = nextScene;
                    choicesDiv.appendChild(button);
                }, 500);
            }
        }

        function makeChoice(index, choice) {
            if (choice.result) {
                gameState.namiAffection += choice.result;
                if (gameState.mode === 'custom') {
                    const notifType = choice.isGood ? 'love' : '';
                    const message = choice.isGood ? 
                        `ãªã¿å…ˆç”Ÿã®å¥½æ„Ÿåº¦ãŒä¸ŠãŒã£ãŸï¼ (+${choice.result})` : 
                        `ãªã¿å…ˆç”Ÿã®åå¿œãŒå¾®å¦™...`;
                    showNotification(message, notifType);
                }
            }
            if (choice.san) {
                gameState.sanValue = Math.max(0, Math.min(100, gameState.sanValue + choice.san));
            }
            updateStatus();
            playSound();
            nextScene();
        }

        function nextScene() {
            gameState.currentScene++;
            showScene();
        }

        function startPhase2() {
            gameState.currentPhase = 2;
            gameState.currentScene = 0;
            currentScenarios = katoPhase2Scenarios;
            showScene();
        }

        const katoPhase2Scenarios = [
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ç¿Œæ—¥ã€è·å“¡å®¤ã€‚åŠ è—¤å…ˆç”Ÿã¯ç²¾ç¥çš„ã«å¼±ã£ã¦ã„ãŸã€‚ãã‚“ãªå½¼ã«è¿‘ã¥ãå¼·çƒˆãªé¦™æ°´ã®åŒ‚ã„...",
                choices: null
            },
            {
                speaker: "æ¾æœ¬",
                text: "ã‚ã‚‰ãã€œã‚“ã€åŠ è—¤ã¡ã‚ƒã‚“â™¡ å…ƒæ°—ãªã„ã‚ã­ã‡ã€œï¼ŸãŠå§‰ã•ã‚“ãŒæ…°ã‚ã¦ã‚ãƒ»ã’ãƒ»ã‚‹â™¡",
                choices: null,
                portrait: "ğŸ’‹"
            },
            {
                speaker: "åŠ è—¤",
                text: "ï¼ˆèƒŒç­‹ãŒå‡ã‚‹ï¼‰ã¾ã€æ¾æœ¬å…ˆç”Ÿ...ãŠæ°—é£ã„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ãŒã€æ¡ç‚¹ãŒ...",
                choices: null,
                portrait: "ğŸ˜°"
            },
            {
                speaker: "æ¾æœ¬",
                text: "ãã‚“ãªã®å¾Œã§ã„ã„ã˜ã‚ƒãªãã„â™¡ ã»ã‚‰ã€æº–å‚™å®¤ã«æ¥ãªã•ãã„ã€œï¼ˆè…•ã‚’æ´ã‚‚ã†ã¨ã™ã‚‹ï¼‰",
                choices: null,
                portrait: "ğŸ’‹"
            },
            {
                speaker: "åŠ è—¤",
                text: "...ï¼ï¼ˆã¨ã£ã•ã«é€ƒã’ã‚‹ï¼‰",
                choices: null,
                portrait: "ğŸƒ"
            },
            {
                speaker: "æ¾æœ¬",
                text: "ã‚ã‚‰ãã€œã‚“ã€é€ƒã’ã¡ã‚ƒãƒ€ãƒ¡ã‚ˆã‰ã€œâ™¡ ã‹ãã€œãã‚Œã‚“ã¼ã‰ã€œâ™¡",
                choices: null,
                portrait: "ğŸ’‹"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "é€ƒèµ°åŠ‡ã‚¹ã‚¿ãƒ¼ãƒˆï¼è·å“¡å®¤ã‹ã‚‰å®‰å…¨åœ°å¸¯ã¾ã§é€ƒã’åˆ‡ã‚Œï¼æ¾æœ¬å…ˆç”Ÿã«æ•ã¾ã£ãŸã‚‰...Bad Endç¢ºå®šï¼",
                choices: null,
                escapeGame: true
            }
        ];

        function checkNamiEnding() {
            if (gameState.namiAffection >= 70) {
                namiGoodEnding();
            } else if (gameState.namiAffection >= 50) {
                namiNormalEnding();
            } else {
                namiBadEnding();
            }
        }

        function namiGoodEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'nami';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ°ğŸ’•</div>
                <h2>True Love Endï¼šå°å‹•ç‰©ç³»å½¼å¥³ã‚²ãƒƒãƒˆï¼</h2>
                <p><strong>${gameState.playerName}:</strong> ã€Œä¿º...åŒ—äº•å…ˆç”Ÿã®ã“ã¨ãŒå¥½ãã§ã™ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œãˆã£...ï¼ã€</p>
                <p>ãªã¿å…ˆç”Ÿã®é¡”ãŒçœŸã£èµ¤ã«ãªã‚‹ã€‚</p>
                <p><strong>ãªã¿:</strong> ã€Œç§ã‚‚...${gameState.playerName}å…ˆç”Ÿã®ã“ã¨...ãšã£ã¨æ°—ã«ãªã£ã¦ã¾ã—ãŸ...ã€</p>
                <p><strong>${gameState.playerName}:</strong> ã€Œæœ¬å½“ã§ã™ã‹...ï¼ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œã¯ã„...å„ªã—ãã¦ã€ã„ã¤ã‚‚åŠ©ã‘ã¦ãã‚Œã¦...å¤§å¥½ãã§ã™â™¡ã€</p>
                <p>å¤•æ—¥ã®ä¸­ã€äºŒäººã¯æ‰‹ã‚’ç¹‹ã„ã ã€‚</p>
                <p>ãã®å¾Œã€äºŒäººã¯è·å“¡å®¤ã§å…¬èªã®ã‚«ãƒƒãƒ—ãƒ«ã¨ãªã‚Šã€<br>
                ä¼‘æ—¥ã«ã¯ãƒ‡ãƒ¼ãƒˆã‚’é‡ã­ã€æ•°å¹´å¾Œã«çµå©šã—ãŸã€‚</p>
                <p style="font-size: 48px; margin: 20px 0;">ğŸ’• HAPPY END ğŸ’•</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                SANå€¤: ${gameState.sanValue}
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function namiNormalEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'normal';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ°</div>
                <h2>Friend Endï¼šå‹é”ä»¥ä¸Šã€æ‹äººæœªæº€</h2>
                <p><strong>${gameState.playerName}:</strong> ã€Œä¿º...åŒ—äº•å…ˆç”Ÿã®ã“ã¨ãŒå¥½ãã§ã™ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œãˆã£...ã€</p>
                <p>ãªã¿å…ˆç”Ÿã¯å›°ã£ãŸé¡”ã‚’ã™ã‚‹ã€‚</p>
                <p><strong>ãªã¿:</strong> ã€Œã”ã‚ã‚“ãªã•ã„...${gameState.playerName}å…ˆç”Ÿã®ã“ã¨ã€è‰¯ã„äººã ã¨æ€ã£ã¦ã¾ã™ã‘ã©...ã€</p>
                <p><strong>${gameState.playerName}:</strong> ã€Œ...ãã†ã§ã™ã‹ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œã§ã‚‚ã€ã“ã‚Œã‹ã‚‰ã‚‚å‹é”ã¨ã—ã¦...ä»²è‰¯ãã—ã¦ãã‚Œã¾ã™ã‹ï¼Ÿã€</p>
                <p>ãã®å¾Œã€äºŒäººã¯è‰¯ãåŒåƒšã¨ã—ã¦åƒãç¶šã‘ãŸã€‚<br>
                æ™‚ã€…ã€ãªã¿å…ˆç”Ÿã¨å¤§è°·å…ˆç”ŸãŒæ¥½ã—ãã†ã«è©±ã—ã¦ã„ã‚‹ã®ã‚’è¦‹ã‹ã‘ã‚‹ã€‚</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                SANå€¤: ${gameState.sanValue}<br>
                â€»å¥½æ„Ÿåº¦70ä»¥ä¸Šã§True Endã«åˆ°é”ã§ãã¾ã™
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function namiBadEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'bad';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ˜°</div>
                <h2>Bad Endï¼šææ€–ã®å‘Šç™½</h2>
                <p><strong>${gameState.playerName}:</strong> ã€Œä¿º...åŒ—äº•å…ˆç”Ÿã®ã“ã¨ãŒå¥½ãã§ã™ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œãˆã£...ï¼ã€</p>
                <p>ãªã¿å…ˆç”Ÿã¯æ˜ã‚‰ã‹ã«æ€¯ãˆãŸè¡¨æƒ…ã‚’è¦‹ã›ã‚‹ã€‚</p>
                <p><strong>ãªã¿:</strong> ã€Œã”ã€ã”ã‚ã‚“ãªã•ã„...ï¼ç§ã€${gameState.playerName}å…ˆç”Ÿã®ã“ã¨ã¡ã‚‡ã£ã¨...æ€–ãã¦...ã€</p>
                <p><strong>${gameState.playerName}:</strong> ã€Œãˆã£...ã€</p>
                <p><strong>ãªã¿:</strong> ã€Œã™ã¿ã¾ã›ã‚“...ï¼ã€ï¼ˆèµ°ã‚Šå»ã‚‹ï¼‰</p>
                <p>ãã®å¾Œã€ãªã¿å…ˆç”Ÿã¯ã‚ãªãŸã‚’é¿ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã€<br>
                å¤§è°·å…ˆç”Ÿã¨ã•ã‚‰ã«è¦ªã—ããªã£ã¦ã„ã£ãŸã€‚</p>
                <p>è·å“¡å®¤ã§ã®æ—¥ã€…ã¯æ°—ã¾ãšã„ã‚‚ã®ã¨ãªã£ãŸ...</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                SANå€¤: ${gameState.sanValue}<br>
                â€»å¥½æ„Ÿåº¦ãŒä½ã™ãã¾ã—ãŸã€‚ã‚‚ã£ã¨å„ªã—ã„é¸æŠè‚¢ã‚’é¸ã¼ã†ï¼
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function startPhase3() {
            gameState.currentPhase = 3;
            gameState.currentScene = 0;
            currentScenarios = katoPhase3Scenarios;
            showScene();
        }

        const katoPhase3Scenarios = [
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "ãªã‚“ã¨ã‹è·å“¡å®¤ã®è‡ªå¸­ã«æˆ»ã£ãŸåŠ è—¤å…ˆç”Ÿã€‚ä½“åŠ›ã‚‚ç²¾ç¥åŠ›ã‚‚é™ç•Œã ã£ãŸã€‚",
                choices: null
            },
            {
                speaker: "ç•‘",
                text: "ã‚ã‚‰ã‚ã‚‰ã€å¤§å¤‰ã ã£ãŸã‚ã­ã‡ã€‚æ¾æœ¬å…ˆç”Ÿã‹ã‚‰é€ƒã’ã¦ããŸã®ï¼Ÿï¼ˆã‚¯ã‚¹ã‚¯ã‚¹ï¼‰",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "...ç•‘å…ˆç”Ÿã€‚ã‚‚ã†...ç–²ã‚Œã¾ã—ãŸ...ï¼ˆæœºã«çªã£ä¼ã™ï¼‰",
                choices: null,
                portrait: "ğŸ˜"
            },
            {
                speaker: "ç•‘",
                text: "ï¼ˆå„ªã—ãèƒŒä¸­ã‚’ã•ã™ã‚‹ï¼‰ã¾ãã¾ãã€‚é£´ã¡ã‚ƒã‚“é£Ÿã¹ã¦å…ƒæ°—å‡ºã—ã¦ã€‚",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "...ãªãœã€ç•‘å…ˆç”Ÿã ã‘ãŒåƒ•ã®è©±ã‚’èã„ã¦ãã‚Œã‚‹ã‚“ã§ã™ã‹ï¼Ÿ",
                choices: null,
                portrait: "ğŸ¤”"
            },
            {
                speaker: "ç•‘",
                text: "ãã‚Œã¯ã­ã€åŠ è—¤å…ˆç”Ÿã€‚ç§ã‚‚æ•°å­¦æ•™å¸«ã ã‹ã‚‰ã€‚ã‚ãªãŸã®è«–ç†çš„æ€è€ƒã€ã‚ˆãã‚ã‹ã‚‹ã®ã‚ˆã€‚",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "...ï¼",
                choices: null,
                effects: true,
                portrait: "ğŸ˜³"
            },
            {
                speaker: "ç•‘",
                text: "ã§ã‚‚ã­ã€åŠ è—¤å…ˆç”Ÿã€‚æ•°å­¦ã«ã‚‚ã€Œæ„Ÿæƒ…ã€ãŒå¿…è¦ãªã®ã€‚ç¾ã—ã„è¨¼æ˜ã«ã¯ã€ã‚¨ãƒ¬ã‚¬ãƒ³ã‚¹ãŒã‚ã‚‹ã€‚",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "ã‚¨ãƒ¬ã‚¬ãƒ³ã‚¹...ï¼Ÿ",
                choices: null,
                portrait: "ğŸ¤”"
            },
            {
                speaker: "ç•‘",
                text: "ãã†ã€‚è«–ç†ã ã‘ã˜ã‚ƒãªã„ã€ä½•ã‹...å¿ƒã‚’æºã•ã¶ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã€‚æ‹æ„›ã‚‚åŒã˜ã‚ˆã€‚",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "...ç•‘å…ˆç”Ÿã¯ã€åƒ•ã®è«–ç†ã‚’å¦å®šã—ãªã„ã€‚ç†è§£ã—ã¦ãã‚Œã‚‹ã€‚åˆã‚ã¦ã§ã™ã€ã“ã‚“ãªæ„Ÿè¦šã€‚",
                choices: null,
                effects: true,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ç•‘",
                text: "ï¼ˆå¾®ç¬‘ã‚€ï¼‰ã‚ã‚‰ã‚ã‚‰ã€ãã‚Œã¯...å¬‰ã—ã„ã‚ã€‚",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "å¤•æš®ã‚Œã®è·å“¡å®¤ã€‚äºŒäººã ã‘ã®é™ã‹ãªæ™‚é–“ã€‚åŠ è—¤å…ˆç”Ÿã®å¿ƒã«ã€æ–°ã—ã„æ„Ÿæƒ…ãŒèŠ½ç”Ÿãˆå§‹ã‚ã¦ã„ãŸã€‚",
                choices: null
            },
            {
                speaker: "åŠ è—¤",
                text: "ç•‘å…ˆç”Ÿ...ã‚ãªãŸã¨ã„ã‚‹ã¨ã€è«–ç†ã‚’è¶…ãˆãŸä½•ã‹ã‚’æ„Ÿã˜ã¾ã™ã€‚",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ç•‘",
                text: "...åŠ è—¤å…ˆç”Ÿï¼Ÿ",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "åƒ•ã¯...è‹¥ã•ã«åŸ·ç€ã—ã¦ã„ã¾ã—ãŸã€‚åŒ—äº•å…ˆç”Ÿã¸ã®æ‹ã‚‚ã€å®Ÿã¯ã€Œè‹¥ã„å¥³æ€§ã‚’æ‰‹ã«å…¥ã‚ŒãŸã„ã€ã¨ã„ã†è«–ç†çš„ç›®æ¨™ã ã£ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
                choices: null,
                effects: true,
                portrait: "ğŸ¤”"
            },
            {
                speaker: "ç•‘",
                text: "...ï¼ˆé™ã‹ã«èã„ã¦ã„ã‚‹ï¼‰",
                choices: null,
                portrait: "ğŸ‘µ"
            },
            {
                speaker: "åŠ è—¤",
                text: "ã§ã‚‚ã€ã‚ãªãŸã¨ã„ã‚‹ã¨...ç›®ã®å‰ã«ã‚ã‚‹ã€Œå®‰ã‚‰ãã€ãŒã€ã©ã‚“ãªè¨ˆç®—å¼ã‚ˆã‚Šã‚‚ç¾ã—ã„è§£ã§ã‚ã‚‹ã¨æ°—ã¥ãã¾ã—ãŸã€‚",
                choices: null,
                portrait: "ğŸ˜Š"
            },
            {
                speaker: "ç•‘",
                text: "åŠ è—¤å…ˆç”Ÿ...ï¼ˆç›®ã«æ¶™ã‚’æµ®ã‹ã¹ã‚‹ï¼‰",
                choices: null,
                portrait: "ğŸ˜¢"
            },
            {
                speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
                text: "åŠ è—¤å…ˆç”Ÿã¯ã€æœ€å¾Œã®é¸æŠã‚’è¿«ã‚‰ã‚Œã‚‹ã€‚",
                choices: [
                    {
                        text: "ãªã¿å…ˆç”Ÿã¸ã®æœªç·´ã‚’æ¨ã¦ãã‚Œãªã„ï¼ˆè‹¥ã•ã¸ã®åŸ·ç€ï¼‰",
                        ending: "normal"
                    },
                    {
                        text: "ç•‘å…ˆç”Ÿã®å„ªã—ã•ã«ç­”ãˆãŸã„ï¼ˆçœŸå®Ÿã®æ„›ï¼‰",
                        ending: "true"
                    }
                ]
            }
        ];

        // æ•°å¼ãƒŸãƒ‹ã‚²ãƒ¼ãƒ 
        function startMathGame() {
            const num1 = Math.floor(Math.random() * 20) + 5;
            const num2 = Math.floor(Math.random() * 20) + 5;
            const operators = ['+', '-', 'Ã—'];
            const operator = operators[Math.floor(Math.random() * operators.length)];
            
            let answer;
            if (operator === '+') answer = num1 + num2;
            else if (operator === '-') answer = num1 - num2;
            else answer = num1 * num2;
            
            document.getElementById('math-question').textContent = `${num1} ${operator} ${num2} = ?`;
            document.getElementById('math-input').value = '';
            document.getElementById('math-input').dataset.answer = answer;
        }

        function submitMathAnswer() {
            const input = document.getElementById('math-input');
            const userAnswer = parseInt(input.value);
            const correctAnswer = parseInt(input.dataset.answer);
            
            if (userAnswer === correctAnswer) {
                gameState.mathCorrect++;
                gameState.sanValue = Math.min(100, gameState.sanValue + 10);
                updateStatus();
                showNotification('æ­£è§£ï¼æ•°å­¦ã®åŠ›ã§SANå€¤ãŒå›å¾©ã—ãŸï¼');
                document.getElementById('math-game').style.display = 'none';
                nextScene();
            } else {
                gameState.sanValue = Math.max(0, gameState.sanValue - 5);
                updateStatus();
                showNotification('ä¸æ­£è§£...ã‚‚ã†ä¸€åº¦è€ƒãˆã‚ˆã†');
            }
        }

        // é€ƒèµ°ã‚²ãƒ¼ãƒ 
        function initEscapeGame() {
            gameState.playerPos = 4;
            gameState.matsumotoPos = 0;
            gameState.escapeTurns = 0;
            renderEscapeMap();
        }

        function renderEscapeMap() {
            const mapGrid = document.getElementById('map-grid');
            mapGrid.innerHTML = '';
            
            const positions = ['å»Šä¸‹', 'éšæ®µ', 'æº–å‚™å®¤', 'å»Šä¸‹', 'è·å“¡å®¤', 'æº–å‚™å®¤', 'éšæ®µ', 'å»Šä¸‹', 'å›³æ›¸å®¤'];
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'map-cell';
                
                if (i === gameState.playerPos) {
                    cell.classList.add('player');
                    cell.textContent = 'ğŸƒ';
                } else if (i === gameState.matsumotoPos) {
                    cell.classList.add('matsumoto');
                    cell.textContent = 'ğŸ’‹';
                } else if (i === 4) {
                    cell.classList.add('safe');
                    cell.textContent = 'ğŸ ';
                } else {
                    cell.textContent = positions[i].substring(0, 2);
                }
                
                cell.onclick = () => movePlayer(i);
                mapGrid.appendChild(cell);
            }
            
            document.getElementById('matsumoto-pos').textContent = positions[gameState.matsumotoPos];
        }

        function movePlayer(newPos) {
            const adjacents = getAdjacents(gameState.playerPos);
            if (!adjacents.includes(newPos)) {
                showNotification('ãã“ã«ã¯ç§»å‹•ã§ãã¾ã›ã‚“ï¼');
                return;
            }
            
            gameState.playerPos = newPos;
            gameState.escapeTurns++;
            
            const matsumotoAdjacents = getAdjacents(gameState.matsumotoPos);
            const matsumotoTarget = matsumotoAdjacents.filter(pos => {
                const distance = getDistance(pos, gameState.playerPos);
                return distance < getDistance(gameState.matsumotoPos, gameState.playerPos);
            });
            
            if (matsumotoTarget.length > 0) {
                gameState.matsumotoPos = matsumotoTarget[Math.floor(Math.random() * matsumotoTarget.length)];
            } else {
                gameState.matsumotoPos = matsumotoAdjacents[Math.floor(Math.random() * matsumotoAdjacents.length)];
            }
            
            renderEscapeMap();
            
            if (gameState.playerPos === gameState.matsumotoPos) {
                document.getElementById('escape-map').style.display = 'none';
                setTimeout(() => {
                    const excuseChance = Math.random() > 0.5;
                    if (excuseChance) {
                        startExcuseInput();
                    } else {
                        badEnding();
                    }
                }, 500);
            } else if (gameState.playerPos === 4) {
                document.getElementById('escape-map').style.display = 'none';
                showNotification('è·å“¡å®¤ã®è‡ªå¸­ã«è¾¿ã‚Šç€ã„ãŸï¼');
                setTimeout(() => startPhase3(), 1500);
            }
        }

        function getAdjacents(pos) {
            const adjacents = [];
            if (pos % 3 !== 0) adjacents.push(pos - 1);
            if (pos % 3 !== 2) adjacents.push(pos + 1);
            if (pos >= 3) adjacents.push(pos - 3);
            if (pos < 6) adjacents.push(pos + 3);
            return adjacents;
        }

        function getDistance(pos1, pos2) {
            const row1 = Math.floor(pos1 / 3);
            const col1 = pos1 % 3;
            const row2 = Math.floor(pos2 / 3);
            const col2 = pos2 % 3;
            return Math.abs(row1 - row2) + Math.abs(col1 - col2);
        }

        function startExcuseInput() {
            document.getElementById('input-section').style.display = 'block';
            document.getElementById('excuse-input').value = '';
            timeLeft = 15;
            updateTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    badEnding();
                }
            }, 1000);
        }

        function updateTimer() {
            document.getElementById('timer').textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}ç§’`;
        }

        function submitExcuse() {
            const input = document.getElementById('excuse-input').value.trim();
            clearInterval(timerInterval);
            
            const logicalWords = ['ãªãœãªã‚‰', 'æ•…ã«', 'ã—ãŸãŒã£ã¦', 'ã‚†ãˆã«', 'è«–ç†çš„', 'è¨ˆç®—', 'è¨¼æ˜', 'ãƒ‡ãƒ¼ã‚¿', 'åŠ¹ç‡'];
            const hasLogic = logicalWords.some(word => input.includes(word));
            
            if (input.length >= 15 && hasLogic) {
                showNotification('è«–ç†çš„ãªè¨€ã„è¨³ãŒåŠŸã‚’å¥ã—ãŸï¼');
                document.getElementById('input-section').style.display = 'none';
                document.getElementById('escape-map').style.display = 'block';
                gameState.matsumotoPos = Math.floor(Math.random() * 9);
                renderEscapeMap();
            } else {
                showNotification('è¨€ã„è¨³ãŒä¸ååˆ†ï¼ã‚‚ã£ã¨è«–ç†çš„ã«ï¼');
                badEnding();
            }
        }

        // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
        function normalEnding() {
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'normal';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ˜”</div>
                <h2>End Aï¼šè¨ˆç®—é•ã„ã®å­¤ç‹¬</h2>
                <p>åŠ è—¤å…ˆç”Ÿã¯ãªã¿å…ˆç”Ÿã¸ã®æ€ã„ã‚’æ¨ã¦ãã‚Œãªã‹ã£ãŸã€‚</p>
                <p>ç¿Œæ—¥ã€æ¸¡ã‚Šå»Šä¸‹ã§å¤§è°·å…ˆç”Ÿã¨ä¸¦ã‚“ã§æ­©ããªã¿å…ˆç”Ÿã‚’é ãã‹ã‚‰è¦‹ã¤ã‚ã‚‹ã€‚</p>
                <p><strong>åŠ è—¤:</strong> ã€Œåƒ•ã®è¨ˆç®—å¼ã®ã©ã“ãŒé–“é•ã£ã¦ã„ãŸã‚“ã ...ã€</p>
                <p>é’ãƒšãƒ³ã‚’æ¡ã‚Šã—ã‚ã€åŠ è—¤å…ˆç”Ÿã¯é€šå¸¸æ¥­å‹™ã«æˆ»ã£ãŸã€‚<br>
                ç•‘å…ˆç”Ÿã¯å„ªã—ãå¾®ç¬‘ã‚“ã§ã„ãŸãŒã€ãã®ç›®ã«ã¯å°‘ã—ã ã‘å¯‚ã—ã•ãŒå®¿ã£ã¦ã„ãŸã€‚</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                ãªã¿å…ˆç”Ÿå¥½æ„Ÿåº¦: ${gameState.namiAffection}<br>
                SANå€¤: ${gameState.sanValue}<br>
                æ•°å­¦æ­£è§£æ•°: ${gameState.mathCorrect}
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function badEnding() {
            clearInterval(timerInterval);
            document.getElementById('game-screen').style.display = 'none';
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'bad';
            endingScreen.style.display = 'block';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ’‹</div>
                <h2>End Bï¼šæ•é£Ÿ</h2>
                <p>æ¾æœ¬å…ˆç”Ÿã®ç½ ã«ã‹ã‹ã£ã¦ã—ã¾ã£ãŸï¼</p>
                <p style="font-size: 64px; margin: 20px 0;">ğŸ’‹</p>
                <p><strong>æ¾æœ¬:</strong> ã€ŒåŠ è—¤ã¡ã‚ƒã‚“ã¯ã€ç§ãŒè‚²ã¦ã¦ã‚ãƒ»ã’ãƒ»ã‚‹â™¡ã€</p>
                <p>åŠ è—¤å…ˆç”Ÿã¯è‹±èªæº–å‚™å®¤ã«é€£ã‚Œè¾¼ã¾ã‚ŒãŸã€‚<br>
                ãã“ã‹ã‚‰å‡ºã¦ããŸæ™‚ã€å½¼ã¯åˆ¥äººã®ã‚ˆã†ã«æ†”æ‚´ã—ãã£ã¦ã„ãŸ...</p>
                <p>æ•°æ—¥å¾Œã€ç•‘å…ˆç”Ÿã¯ç©ºå¸­ã¨ãªã£ãŸéš£ã®å¸­ã‚’è¦‹ã¦ã€å°ã•ããŸã‚æ¯ã‚’ã¤ã„ãŸã€‚</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                SANå€¤: ${gameState.sanValue}<br>
                é€ƒèµ°ã‚¿ãƒ¼ãƒ³æ•°: ${gameState.escapeTurns}
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function trueEnding() {
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.className = 'true';
            endingScreen.innerHTML = `
                <div class="character-portrait">ğŸ‘µğŸ’•</div>
                <h2>End Cï¼šè¨¼æ˜å®Œäº†</h2>
                <p>å¤•æš®ã‚Œã®è·å“¡å®¤ã€‚åŠ è—¤å…ˆç”Ÿã¯é’ãƒšãƒ³ã‚’ç½®ãã€ç•‘å…ˆç”Ÿã‹ã‚‰è²°ã£ãŸé»’ç³–é£´ã‚’èˆã‚ã‚‹ã€‚</p>
                <p><strong>åŠ è—¤:</strong> ã€Œéè«–ç†çš„ã ã¨æ€ã£ã¦ã„ãŸãŒ...æ‚ªããªã„ã€</p>
                <p><strong>ç•‘:</strong> ã€Œã‚ã‚‰ã‚ã‚‰ã€ãã†ã§ã—ã‚‡ã†ï¼Ÿäººç”Ÿã€è¨ˆç®—é€šã‚Šã«ã¯ã„ã‹ãªã„ã‚‚ã®ã‚ˆã€</p>
                <p>ç•‘å…ˆç”Ÿã¯å„ªã—ãå¾®ç¬‘ã¿ã€åŠ è—¤å…ˆç”Ÿã®æ‰‹ã‚’æ¡ã‚‹ã€‚</p>
                <p><strong>åŠ è—¤:</strong> ã€Œç•‘å…ˆç”Ÿ...åƒ•ã¯ä»Šã€äººç”Ÿã§æœ€ã‚‚ç¾ã—ã„è¨¼æ˜ã‚’å®Œæˆã•ã›ãŸæ°—ãŒã—ã¾ã™ã€</p>
                <p><strong>ç•‘:</strong> ã€ŒQ.E.D.ï¼ˆè¨¼æ˜çµ‚äº†ï¼‰ã­ã€åŠ è—¤å…ˆç”Ÿã€</p>
                <p>äºŒäººã¯å®šå¹´ã¾ã§ä»²è‰¯ãéš£ã®å¸­ã§åƒãç¶šã‘ãŸã€‚<br>
                æ™‚ã€…ã€æ¾æœ¬å…ˆç”Ÿã‹ã‚‰é€ƒã’ãªãŒã‚‰ã€‚</p>
                <p style="font-size: 48px; margin: 20px 0;">ğŸŒŸ TRUE END ğŸŒŸ</p>
                <p style="margin-top: 20px; font-size: 14px; color: #666;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                SANå€¤: ${gameState.sanValue}<br>
                æ•°å­¦æ­£è§£æ•°: ${gameState.mathCorrect}<br>
                ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—æ•°: ${gameState.items.length}
                </p>
                <button class="restart-button" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            `;
        }

        function showNotification(message, type = '') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = type;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        function playSound() {
            console.log('ã‚«ãƒãƒƒï¼ˆãƒœãƒ¼ãƒ«ãƒšãƒ³ã®ãƒãƒƒã‚¯éŸ³ï¼‰');
        }
    </script>
</body>
</html>